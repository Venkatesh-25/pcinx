<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<title>FRA Atlas DSS - Decision Support System</title>

	<!-- Keep your existing external references (unchanged) -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

	<!-- Modern font -->
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

	<style>
		:root{
			--bg-1: 20 22 28;          /* dark base (r g b) */
			--glass-1: rgba(255,255,255,0.06);
			--glass-2: rgba(255,255,255,0.04);
			--accent: 45 80 22;       /* green-ish accent rgb */
			--accent-hex: #2d5016;
			--muted: #9aa3ab;
			--card-radius: 14px;
			--transition: 0.25s;
		}

		/* Light theme variables */
		body[data-theme="light"]{
			--bg-1: 102 126 234;
			--glass-1: rgba(255,255,255,0.95);
			--glass-2: rgba(255,255,255,0.9);
			--muted: #666;
			--accent: 45 80 22;
			--accent-hex: #2d5016;
		}

		*{box-sizing:border-box;margin:0;padding:0}
		html,body{height:100%}
		body {
			font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
			background: radial-gradient(1200px 600px at 10% 10%, rgba(45,80,22,0.08), transparent),
			            radial-gradient(1200px 600px at 90% 90%, rgba(39, 174, 96, 0.03), transparent),
			            rgba(var(--bg-1),1);
			color: #e6eef8;
			-webkit-font-smoothing:antialiased;
			-moz-osx-font-smoothing:grayscale;
			height:100vh;
			overflow:hidden;
			transition: background var(--transition) ease;
		}

		/* Layout */
		.header {
			position: relative;
			z-index: 1200;
			display:flex;
			align-items:center;
			justify-content:space-between;
			padding:18px 22px;
			gap:16px;
			backdrop-filter: blur(10px) saturate(110%);
			background: linear-gradient(180deg, rgba(var(--bg-1),0.12), rgba(var(--bg-1),0.06));
			border-radius: 12px;
			margin: 14px;
			box-shadow: 0 6px 30px rgba(0,0,0,0.35);
		}

		.brand {
			display:flex;
			align-items:center;
			gap:12px;
		}

		.logo-mark {
			width:48px;height:48px;border-radius:12px;
			background: linear-gradient(135deg, rgba(var(--accent),0.12), rgba(var(--accent),0.06));
			display:flex;align-items:center;justify-content:center;
			border: 1px solid rgba(255,255,255,0.04);
			box-shadow: 0 6px 18px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.02);
		}

		.logo-mark i{color:var(--accent-hex);font-size:20px}
		.title {
			display:flex;flex-direction:column;
		}
		.title h1{
			font-size:18px;color: var(--accent-hex);font-weight:700;
		}
		.title p{font-size:12px;color:var(--muted);margin-top:2px}

		.header-controls {
			display:flex;align-items:center;gap:10px;
		}

		.btn {
			padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600;
			backdrop-filter: blur(6px);
			background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
			color: #e9f4ee;
			box-shadow: 0 6px 14px rgba(0,0,0,0.35);
			transition: transform .18s ease, box-shadow .18s ease;
			display:inline-flex;align-items:center;gap:8px;
		}
		.btn:hover{transform:translateY(-3px)}
		.btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06)}
		.btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,0.03)}

		.status-bar {
			display:flex;gap:10px;align-items:center;
		}
		.status-item {
			padding:8px 12px;border-radius:10px;background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
			font-size:13px;color:var(--muted);display:flex;gap:8px;align-items:center;border:1px solid rgba(255,255,255,0.03)
		}
		.status-item i{color:var(--accent-hex)}

		/* Main */
		.main-container {
			display:flex;
			height: calc(100vh - 120px);
			margin: 14px;
			gap: 18px;
		}

		/* Map area */
		#map {
			flex:1;
			border-radius: 16px;
			overflow: hidden;
			box-shadow: 0 20px 60px rgba(0,0,0,0.6);
			border: 1px solid rgba(255,255,255,0.02);
		}

		/* Dashboard */
		.dashboard {
			width:380px;
			min-width:300px;
			max-width:420px;
			padding:20px;
			border-radius: var(--card-radius);
			backdrop-filter: blur(12px) saturate(120%);
			background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
			border: 1px solid rgba(255,255,255,0.03);
			box-shadow: 0 20px 60px rgba(0,0,0,0.5);
			overflow-y:auto;
		}

		.dashboard-section {
			margin-bottom:18px;padding:16px;border-radius:12px;
			background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
			border: 1px solid rgba(255,255,255,0.025);
		}

		.section-title{display:flex;align-items:center;gap:10px;margin-bottom:12px}
		.section-title h3{font-size:14px;color:var(--accent-hex);margin:0}
		.section-title p{font-size:12px;color:var(--muted);margin:0}

		.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
		.stat-card{
			padding:12px;border-radius:10px;background: linear-gradient(180deg, rgba(0,0,0,0.18), rgba(0,0,0,0.12));
			border:1px solid rgba(255,255,255,0.02);
			text-align:center;
		}
		.stat-number{font-size:20px;font-weight:800;color:#fff}
		.stat-label{font-size:12px;color:var(--muted);margin-top:6px;text-transform:uppercase;letter-spacing:0.6px}

		.control-btn{
			width:100%;padding:12px;border-radius:10px;border:none;font-weight:700;cursor:pointer;margin-top:8px;
			backdrop-filter: blur(6px);
			transition: transform .18s ease;
		}
		.control-btn:hover{transform:translateY(-3px)}
		.btn-before{background: linear-gradient(135deg, rgba(39,174,96,0.95), rgba(34,197,94,0.9)); color:#fff}
		.btn-after{background: linear-gradient(135deg, rgba(220,53,69,0.95), rgba(200,32,35,0.9)); color:#fff}
		.btn-reset{background: linear-gradient(135deg, rgba(59,130,246,0.95), rgba(37,99,235,0.9)); color:#fff}
		.btn-export{background: linear-gradient(135deg, rgba(16,185,129,0.95), rgba(34,197,94,0.9)); color:#fff}
		.btn-report{background: linear-gradient(135deg, rgba(239,68,68,0.95), rgba(220,38,38,0.9)); color:#fff}

		/* Alert */
		.alert {
			padding:12px;border-radius:10px;margin-bottom:14px;
			background: linear-gradient(90deg, rgba(244,67,54,0.15), rgba(255, 208, 208,0.03));
			border: 1px solid rgba(244,67,54,0.12);
			color:#ffdede;
			display:flex;align-items:flex-start;gap:12px;
		}
		.alert strong{color:#ffdede}

		/* Legend (map overlay) */
		.legend{
			position:absolute;bottom:22px;left:22px;padding:12px;border-radius:10px;z-index:1100;
			background: linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.28));
			border:1px solid rgba(255,255,255,0.04)
		}
		.legend h4{margin:0 0 10px 0;color:var(--accent-hex)}
		.legend-item{display:flex;gap:10px;align-items:center;color:#e6eef8;margin-bottom:8px}
		.legend-color{width:18px;height:18px;border-radius:4px;border:2px solid rgba(0,0,0,0.4)}

		/* Popups */
		.popup-custom, .custom-popup { font-family: inherit; color: #111 }
		.leaflet-popup-content-wrapper { border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.3) !important; }

		/* Modal */
		.modal { display: none; position: fixed; z-index: 1400; left:0;top:0;width:100%;height:100%;background: rgba(0,0,0,0.45); align-items:center; justify-content:center; }
		.modal.open{display:flex}
		.modal-card{ width:94%; max-width:520px; border-radius:14px; overflow:hidden; background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.94)); color:#111; box-shadow: 0 30px 70px rgba(0,0,0,0.5) }
		.modal-header{ padding:18px 20px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid rgba(0,0,0,0.06)}
		.modal-body{ padding:18px 20px; max-height:65vh; overflow:auto }
		.modal .close { background:transparent;border:none; font-size:20px; cursor:pointer; color:#333; }

		.form-group{ margin-bottom:12px }
		.form-group label{ display:block; font-weight:700; font-size:13px; margin-bottom:6px }
		.form-group input, .form-group select, .form-group textarea {
			width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(0,0,0,0.08); font-size:14px;
		}

		/* Login badge */
		.user-badge{ display:inline-flex; gap:10px; align-items:center; padding:8px 10px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03); font-weight:700; color:#fff }
		.user-role{ font-size:12px; color:var(--muted) }

		/* small screens */
		@media (max-width:900px){
			.dashboard{ display:none }
			.main-container{ margin:8px }
		}
	</style>
</head>
<body data-theme="dark">
	<!-- Loading overlay -->
	<div id="loading" style="display:none;position:fixed;z-index:1600;left:0;top:0;width:100%;height:100%;align-items:center;justify-content:center;background:rgba(0,0,0,0.45)">
		<div style="background:rgba(255,255,255,0.03);backdrop-filter:blur(6px);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);color:#fff">
			<div style="margin-bottom:8px;font-weight:700">Analyzing satellite data...</div>
			<div style="height:6px;background:rgba(255,255,255,0.06);border-radius:6px;overflow:hidden">
				<div style="width:48%;height:100%;background:linear-gradient(90deg, rgba(39,174,96,0.95), rgba(34,197,94,0.9));animation:progress 2s linear infinite"></div>
			</div>
		</div>
	</div>

	<header class="header">
		<div class="brand">
			<div class="logo-mark"><i class="fas fa-tree"></i></div>
			<div class="title">
				<h1>FRA Atlas DSS</h1>
				<p>AI-powered FRA Atlas & WebGIS Decision Support System</p>
			</div>
		</div>

		<div style="display:flex;gap:12px;align-items:center">
			<div class="status-bar" style="margin-right:14px">
				<div class="status-item"><i class="fas fa-satellite"></i><span>Sentinel-2 Connected</span></div>
				<div class="status-item"><i class="fas fa-database"></i><span>4 States Loaded</span></div>
			</div>

			<div class="header-controls">
				<button id="themeToggle" class="btn secondary" title="Toggle dark / light mode"><i class="fas fa-adjust"></i> Theme</button>
				<button id="aboutBtn" class="btn ghost"><i class="fas fa-info-circle"></i> About</button>
				<button id="loginOpen" class="btn"><i class="fas fa-sign-in-alt"></i> Login</button>
				<div id="userBadge" style="display:none" class="user-badge"><span id="userName">User</span> <span class="user-role" id="userRoleTag"></span></div>
			</div>
		</div>
	</header>

	<!-- Main -->
	<div class="main-container">
		<div id="map"></div>

		<aside class="dashboard" aria-label="Control dashboard">
			<div class="alert" role="status">
				<div style="flex:1">
					<strong>Deforestation Alert</strong>
					<div style="font-size:13px;margin-top:6px;color:var(--muted)">Forest loss detected in CFR-2024-OD-101 — requires verification</div>
				</div>
				<div style="min-width:90px;text-align:right">
					<button id="exportBtn" class="btn control-btn btn-export" style="width:100%">Generate Report</button>
				</div>
			</div>

			<div class="dashboard-section">
				<div class="section-title">
					<h3>FRA Claims Overview</h3>
					<p style="margin-left:auto" id="coverageInfo">Coverage: 4 States</p>
				</div>

				<div class="stat-grid">
					<div class="stat-card">
						<div class="stat-number" id="approved-count">1,247</div>
						<div class="stat-label">Approved</div>
					</div>
					<div class="stat-card">
						<div class="stat-number" id="pending-count">156</div>
						<div class="stat-label">Pending</div>
					</div>
					<div class="stat-card">
						<div class="stat-number" id="review-count">43</div>
						<div class="stat-label">Under Review</div>
					</div>
					<div class="stat-card">
						<div class="stat-number" id="rejected-count">12</div>
						<div class="stat-label">Rejected</div>
					</div>
				</div>

				<div style="margin-top:12px;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(0,0,0,0.08), rgba(0,0,0,0.04));font-size:13px;color:var(--muted)">
					<strong>Live Updates:</strong> <span id="last-update">Real-time monitoring active</span>
				</div>
			</div>

			<div class="dashboard-section">
				<div class="section-title">
					<h3>Satellite Monitoring</h3>
					<p>Compare NDVI analysis from Sentinel-2</p>
				</div>

				<button id="beforeBtn" class="control-btn btn-before">January 2025 (Baseline)</button>
				<button id="afterBtn" class="control-btn btn-after">September 2025 (Current)</button>
				<button id="resetBtn" class="control-btn btn-reset">Reset View</button>
				<button id="reportBtn" class="control-btn btn-report">Report Issue</button>
			</div>

			<div class="dashboard-section">
				<div class="section-title">
					<h3>System Analytics</h3>
				</div>
				<div style="color:var(--muted);font-size:13px;line-height:1.6">
					<p><strong>Coverage:</strong> 4 States (Odisha, Madhya Pradesh, Tripura, Telangana)</p>
					<p><strong>Last Update:</strong> <span id="lastUpdateText">2 hours ago</span></p>
					<p><strong>NDVI Threshold:</strong> 0.3 (Deforestation alert)</p>
					<p><strong>Spatial Resolution:</strong> 10m (Sentinel-2)</p>
				</div>
			</div>

			<div class="dashboard-section">
				<div class="section-title">
					<h3>Community Impact</h3>
				</div>
				<div class="stat-grid">
					<div class="stat-card">
						<div class="stat-number">8,542</div>
						<div class="stat-label">Families Protected</div>
					</div>
					<div class="stat-card">
						<div class="stat-number">24,156</div>
						<div class="stat-label">Hectares Secured</div>
					</div>
				</div>
			</div>

			<!-- SIH problem statement summary -->
			<div class="dashboard-section" style="border-left:4px solid rgba(var(--accent),0.9)">
				<div class="section-title"><h3>SIH Alignment (SIH12508)</h3></div>
				<div style="font-size:13px;color:var(--muted);line-height:1.5">
					<p><strong>Problem:</strong> Development of AI-powered FRA Atlas and WebGIS-based Decision Support System for Integrated Monitoring of Forest Rights Act (FRA) implementation.</p>
					<p><strong>Target States:</strong> Madhya Pradesh, Tripura, Odisha, Telangana</p>
					<p>This UI & mapping tool implements multi-state claim loading, NDVI overlays, reporting, and an official review workflow to meet SIH12508 requirements.</p>
				</div>
			</div>
		</aside>
	</div>

	<!-- Report Issue Modal -->
	<div id="reportModal" class="modal" aria-hidden="true">
		<div class="modal-card">
			<div class="modal-header">
				<div style="display:flex;gap:12px;align-items:center">
					<h3 style="margin:0">Report Environmental Issue</h3>
					<span style="font-size:12px;color:var(--muted)">Submit a new report for the Forest Department</span>
				</div>
				<button class="close" id="closeModal">&times;</button>
			</div>
			<div class="modal-body">
				<form id="reportForm">
					<div class="form-group">
						<label for="issueType">Issue Type *</label>
						<select id="issueType" required>
							<option value="">Select issue type</option>
							<option value="deforestation">Illegal Deforestation</option>
							<option value="encroachment">Forest Encroachment</option>
							<option value="mining">Unauthorized Mining</option>
							<option value="dumping">Waste Dumping</option>
							<option value="other">Other Environmental Violation</option>
						</select>
					</div>

					<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
						<div class="form-group">
							<label for="reporterName">Your Name *</label>
							<input type="text" id="reporterName" required>
						</div>
						<div class="form-group">
							<label for="reporterPhone">Phone Number</label>
							<input type="tel" id="reporterPhone">
						</div>
					</div>

					<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
						<div class="form-group">
							<label for="location">Location/Village *</label>
							<input type="text" id="location" required>
						</div>
						<div class="form-group">
							<label for="district">District *</label>
							<input type="text" id="district" required>
						</div>
					</div>

					<div class="form-group">
						<label for="description">Detailed Description *</label>
						<textarea id="description" placeholder="Describe the issue, estimated area, when observed..." required></textarea>
					</div>

					<div class="form-group">
						<label for="coordinates">GPS Coordinates (if available)</label>
						<input type="text" id="coordinates" placeholder="Latitude, Longitude (e.g., 20.2961, 85.8245)">
					</div>

					<button type="submit" class="btn" style="width:100%;background:linear-gradient(135deg, rgba(39,174,96,0.95), rgba(34,197,94,0.9));color:#fff">Submit Report</button>
				</form>
			</div>
		</div>
	</div>

	<!-- About / SIH Modal -->
	<div id="aboutModal" class="modal" aria-hidden="true">
		<div class="modal-card">
			<div class="modal-header">
				<h3 style="margin:0">About FRA Atlas DSS</h3>
				<button class="close" id="closeAbout">&times;</button>
			</div>
			<div class="modal-body">
				<p style="font-size:14px;color:#111;line-height:1.6">
					This application is built to satisfy SIH Problem Statement <strong>SIH12508</strong> for the Ministry of Tribal Affairs (MoTA): <em>Development of AI-powered FRA Atlas and WebGIS-based Decision Support System (DSS) for Integrated Monitoring of Forest Rights Act (FRA) Implementation</em>.
				</p>
				<ul style="color:#111">
					<li>States concentrated: <strong>Odisha, Madhya Pradesh, Tripura, Telangana</strong></li>
					<li>Features included: multi-state GeoJSON claim loading, NDVI overlays, reporting workflow, official review controls</li>
					<li>Satellite source: Sentinel-2 (10m)</li>
				</ul>

				<p style="font-size:13px;color:var(--muted)">Designer note: Login has two roles — Citizen and Government Official. Officials can review and change claim status from the claim popup. For production, authenticate using your backend/auth provider and connect claim update endpoints.</p>
			</div>
		</div>
	</div>

	<!-- Login Modal -->
	<div id="loginModal" class="modal" aria-hidden="true">
		<div class="modal-card">
			<div class="modal-header">
				<h3 style="margin:0">Login</h3>
				<button class="close" id="closeLogin">&times;</button>
			</div>
			<div class="modal-body">
				<form id="loginForm">
					<div class="form-group">
						<label for="roleSelect">Login As</label>
						<select id="roleSelect" required>
							<option value="citizen">Citizen</option>
							<option value="official">Government Official</option>
						</select>
					</div>

					<div class="form-group">
						<label for="username">Username</label>
						<input id="username" type="text" placeholder="demo user" required>
					</div>

					<div class="form-group">
						<label for="password">Password</label>
						<input id="password" type="password" placeholder="demo password" required>
					</div>

					<div style="display:flex;gap:8px">
						<button type="submit" class="btn" style="flex:1;background:linear-gradient(135deg, rgba(59,130,246,0.95), rgba(37,99,235,0.9));">Sign in</button>
						<button type="button" id="loginDemo" class="btn secondary" style="flex:1">Demo</button>
					</div>

					<p style="font-size:12px;color:var(--muted);margin-top:10px">Demo credentials accepted for both roles for UI demo purposes.</p>
				</form>
			</div>
		</div>
	</div>

	<!-- Loading small -->
	<div id="loadingSpinner" style="display:none;position:fixed;z-index:2000;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.95);padding:18px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.3);">
		<div style="height:40px;margin-bottom:10px;background:linear-gradient(90deg, rgba(39,174,96,0.95), rgba(34,197,94,0.9));width:40px;border-radius:50%"></div>
		<div style="text-align:center;font-weight:700;color:var(--accent-hex)">Processing...</div>
	</div>

	<!-- Legend -->
	<div class="legend">
		<h4>Map Legend</h4>
		<div class="legend-item"><div class="legend-color" style="background-color:#ff7800"></div><div>FRA Claim Boundary</div></div>
		<div class="legend-item"><div class="legend-color" style="background-color:#4CAF50;opacity:0.8"></div><div>Healthy Vegetation (High NDVI)</div></div>
		<div class="legend-item"><div class="legend-color" style="background-color:#ff6b6b;opacity:0.8"></div><div>Forest Loss (Low NDVI)</div></div>
	</div>

	<!-- Keep Leaflet script reference unchanged -->
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

	<script>
		// === Global state for demo login & roles ===
		let currentUser = null; // { username, role: 'citizen' | 'official' }

		// Utilities to show/hide modals
		const showModal = (id) => document.getElementById(id).classList.add('open') || (document.getElementById(id).style.display = 'flex');
		const hideModal = (id) => document.getElementById(id).classList.remove('open') || (document.getElementById(id).style.display = 'none');

		// DOM references
		const loginOpenBtn = document.getElementById('loginOpen');
		const loginModal = document.getElementById('loginModal');
		const closeLogin = document.getElementById('closeLogin');
		const loginForm = document.getElementById('loginForm');
		const loginDemoBtn = document.getElementById('loginDemo');
		const userBadge = document.getElementById('userBadge');
		const userNameEl = document.getElementById('userName');
		const userRoleTag = document.getElementById('userRoleTag');

		loginOpenBtn.addEventListener('click', () => {
			showModal('loginModal');
		});
		closeLogin.addEventListener('click', () => hideModal('loginModal'));
		document.getElementById('closeModal').addEventListener('click', () => hideModal('reportModal'));
		document.getElementById('closeAbout').addEventListener('click', () => hideModal('aboutModal'));
		document.getElementById('aboutBtn').addEventListener('click', () => showModal('aboutModal'));

		loginForm.addEventListener('submit', function(e){
			e.preventDefault();
			const role = document.getElementById('roleSelect').value;
			const username = document.getElementById('username').value.trim() || 'User';
			// For demo: accept any credentials
			currentUser = { username, role };
			afterLogin();
			hideModal('loginModal');
		});

		loginDemoBtn.addEventListener('click', () => {
			// Toggle between a sample citizen and official for quick testing
			const role = document.getElementById('roleSelect').value;
			currentUser = { username: role === 'official' ? 'official.demo' : 'citizen.demo', role };
			afterLogin();
			hideModal('loginModal');
		});

		function afterLogin(){
			if (!currentUser) return;
			userBadge.style.display = 'inline-flex';
			userNameEl.textContent = currentUser.username;
			userRoleTag.textContent = currentUser.role === 'official' ? 'Government Official' : 'Citizen';
			loginOpenBtn.style.display = 'none';
		}

		// Simple logout (clicking the badge logs out)
		userBadge.addEventListener('click', () => {
			currentUser = null;
			userBadge.style.display = 'none';
			loginOpenBtn.style.display = 'inline-flex';
		});

		// === Theme toggle (dark/light) ===
		const themeToggle = document.getElementById('themeToggle');
		themeToggle.addEventListener('click', () => {
			const body = document.body;
			const current = body.getAttribute('data-theme') || 'dark';
			const next = current === 'dark' ? 'light' : 'dark';
			body.setAttribute('data-theme', next);
		});

		// === Map initialization (preserved, minimal changes) ===
		var map = L.map('map', {
			center: [20.2961, 85.8245],
			zoom: 12,
			zoomControl: false
		});
		L.control.zoom({ position: 'topright' }).addTo(map);

		var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
			maxZoom: 18,
		}).addTo(map);
		var positron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
			attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a>, &copy; OpenStreetMap contributors',
			maxZoom: 19
		});
		var baseMaps = { "OpenStreetMap": osm, "Positron (Light)": positron };
		var overlayMaps = {}; // we'll add claimsGroup later
		var layerControl = L.control.layers(baseMaps, overlayMaps, { position: 'topright', collapsed: true }).addTo(map);

		// Built-in sample claim (preserve)
		var claimBoundary = {
			"type": "Feature",
			"properties": {
				"name": "CFR-2024-OD-101",
				"village": "Khandagiri",
				"district": "Khurda",
				"area": "245 hectares",
				"status": "Approved",
				"claimants": "127 families",
				"approval_date": "2024-03-15",
				"claim_id": "CFR-2024-OD-101",
				"state": "Odisha",
				"deforestation_detected": true,
				"area_hectares": 245,
				"claimant_families": 127
			},
			"geometry": {
				"type": "Polygon",
				"coordinates": [[
					[85.8100, 20.3100],
					[85.8300, 20.3100],
					[85.8300, 20.2900],
					[85.8100, 20.2900],
					[85.8100, 20.3100]
				]]
			}
		};

		// Add claims group
		var claimLayer = L.geoJSON(claimBoundary, { style: claimStyle, onEachFeature: onEachFeatureBasic });
		var claimsGroup = L.layerGroup([claimLayer]).addTo(map);
		overlayMaps["FRA Claims"] = claimsGroup;
		layerControl.addOverlay(claimsGroup, "FRA Claims");

		function claimStyle(feature){
			const props = feature.properties || {};
			const status = (props.status || '').toLowerCase();
			let color = '#ff7800';
			if (status.includes('pending')) color = '#f1c40f';
			else if (status.includes('reject') || status.includes('rejected')) color = '#c0392b';
			else if (status.includes('review')) color = '#8e44ad';
			else if (status.includes('approved')) color = '#27ae60';
			const hasAlert = props.deforestation_detected;
			return {
				color: hasAlert ? '#e74c3c' : color,
				weight: hasAlert ? 3.5 : 2.5,
				fillColor: color,
				fillOpacity: hasAlert ? 0.4 : 0.2,
				dashArray: hasAlert ? '5,5' : null
			};
		}

		// Basic onEachFeature for fallback sample
		function onEachFeatureBasic(feature, layer){
			const name = feature.properties.claim_id || feature.properties.name || 'Claim';
			const status = feature.properties.status || 'Unknown';
			const area = (feature.properties.area_hectares ? feature.properties.area_hectares + ' ha' : (feature.properties.area || '—'));
			const village = feature.properties.village || '—';
			const district = feature.properties.district || '—';
			const state = feature.properties.state || '—';
			const families = feature.properties.claimant_families || feature.properties.claimants || '—';
			const alertHTML = feature.properties.deforestation_detected ? '<div style="color:#c0392b;font-weight:700;margin-top:8px;padding:6px;border-radius:6px;background:#fff5f5">DEFORESTATION ALERT</div>' : '<div style="color:#27ae60;font-weight:700;margin-top:8px">No Active Alerts</div>';
			const claimId = feature.properties.claim_id || name;

			const popupContent = `
				<div style="min-width:240px;font-family:inherit;">
					<h4 style="margin:0 0 8px 0;color:var(--accent-hex)">${name}</h4>
					<p style="margin:4px 0"><strong>State:</strong> ${state}</p>
					<p style="margin:4px 0"><strong>Village:</strong> ${village}</p>
					<p style="margin:4px 0"><strong>District:</strong> ${district}</p>
					<p style="margin:4px 0"><strong>Status:</strong> <span style="font-weight:700">${status}</span></p>
					<p style="margin:4px 0"><strong>Area:</strong> ${area}</p>
					<p style="margin:4px 0"><strong>Families:</strong> ${families}</p>
					${alertHTML}
					<div style="margin-top:10px" data-claim-id="${claimId}" class="action-area"></div>
				</div>
			`;
			layer.bindPopup(popupContent, { maxWidth:300, className:'popup-custom' });
		}

		// NDVI overlay creation preserved
		function createNDVIOverlay(type) {
			var canvas = document.createElement('canvas');
			canvas.width = 200; canvas.height = 200;
			var ctx = canvas.getContext('2d');
			if (type === 'before') {
				var gradient = ctx.createLinearGradient(0,0,200,200);
				gradient.addColorStop(0, 'rgba(76, 175, 80, 0.7)');
				gradient.addColorStop(1, 'rgba(139, 195, 74, 0.7)');
				ctx.fillStyle = gradient;
			} else {
				ctx.fillStyle = 'rgba(76, 175, 80, 0.7)';
				ctx.fillRect(0,0,200,200);
				ctx.fillStyle = 'rgba(244, 67, 54, 0.8)';
				ctx.fillRect(60,80,80,40);
				ctx.fillRect(120,140,40,30);
				ctx.fillRect(30,150,50,25);
			}
			if (type === 'before') ctx.fillRect(0,0,200,200);
			return canvas.toDataURL();
		}
		var imageBounds = [[20.2900, 85.8100], [20.3100, 85.8300]];
		var beforeImageData = createNDVIOverlay('before');
		var afterImageData = createNDVIOverlay('after');

		var beforeOverlay = L.imageOverlay(beforeImageData, imageBounds, { opacity: 0.6, interactive: false });
		var afterOverlay = L.imageOverlay(afterImageData, imageBounds, { opacity: 0.6, interactive: false });

		// Button handlers (preserve flow but remove emojis)
		document.getElementById('beforeBtn').addEventListener('click', function() {
			showLoading();
			setTimeout(function() {
				map.removeLayer(afterOverlay);
				beforeOverlay.addTo(map);
				hideLoading();
				var popup = L.popup().setLatLng([20.3000,85.8200]).setContent('<div style="text-align:center;"><strong>January 2025</strong><br>Healthy Forest Cover<br>NDVI: 0.75 (High)</div>').openOn(map);
				setTimeout(()=>map.closePopup(), 3000);
			}, 1200);
		});

		document.getElementById('afterBtn').addEventListener('click', function() {
			showLoading();
			setTimeout(function() {
				map.removeLayer(beforeOverlay);
				afterOverlay.addTo(map);
				hideLoading();
				var popup = L.popup().setLatLng([20.2980,85.8150]).setContent('<div style="text-align:center;color:#c0392b;"><strong>September 2025</strong><br>Deforestation Detected<br>NDVI: 0.21 (Critical)</div>').openOn(map);
				setTimeout(()=>map.closePopup(), 3500);
			}, 1200);
		});

		document.getElementById('resetBtn').addEventListener('click', function(){
			map.removeLayer(beforeOverlay); map.removeLayer(afterOverlay);
			map.setView([20.2961,85.8245], 12);
		});

		// Export report - keep original generation, remove emojis and use notifications
		document.getElementById('exportBtn').addEventListener('click', function(){
			showCustomLoading();
			setTimeout(function(){
				hideCustomLoading();
				const reportData = generateReportData();
				const reportContent = `
FRA ATLAS DECISION SUPPORT SYSTEM - COMPREHENSIVE REPORT
Generated on: ${new Date().toLocaleString()}

EXECUTIVE SUMMARY
Total FRA Claims Monitored: ${reportData.totalClaims}
States Covered: Odisha, Madhya Pradesh, Tripura, Telangana
Monitoring Period: January 2025 - September 2025

CLAIM STATUS DISTRIBUTION
Approved Claims: ${reportData.approved}
Pending Review: ${reportData.pending}
Under Review: ${reportData.review}
Rejected Claims: ${reportData.rejected}

ENVIRONMENTAL ALERTS
Deforestation Detected: ${reportData.deforestationAlerts} locations
High-risk Areas: ${reportData.highRiskAreas}
NDVI Threshold Violations: ${reportData.ndviViolations}

COMMUNITY IMPACT
Total Families Protected: 8,542
Forest Area Secured: 24,156 hectares
Average Claim Size: ${(24156/reportData.totalClaims).toFixed(1)} hectares

TECHNICAL SPECIFICATIONS
Satellite Data Source: Sentinel-2 (10m resolution)
NDVI Calculation: Band 8 (NIR) and Band 4 (Red)
Deforestation Threshold: NDVI < 0.3
Update Frequency: Bi-weekly

RECOMMENDATIONS
1. Prioritize review of ${reportData.pending} pending claims
2. Investigate ${reportData.deforestationAlerts} deforestation alerts
3. Deploy ground verification teams to high-risk areas
4. Strengthen community-based monitoring programs

Report generated by FRA Atlas DSS v1.0
For SIH 2025 - Problem Statement SIH12508
Team: Green Guardians
				`;
				const blob = new Blob([reportContent], { type: 'text/plain' });
				const url = window.URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = `FRA_Atlas_Report_${new Date().toISOString().split('T')[0]}.txt`;
				document.body.appendChild(a);
				a.click();
				document.body.removeChild(a);
				window.URL.revokeObjectURL(url);
				setTimeout(()=> { alert('Report generated and downloaded. The report includes claim status, alerts, NDVI trends and community impact.'); }, 300);
			}, 1400);
		});

		// Report Issue Modal open/close
		const modal = document.getElementById('reportModal');
		const reportBtn = document.getElementById('reportBtn');
		const closeModal = document.getElementById('closeModal');
		const reportForm = document.getElementById('reportForm');

		reportBtn.addEventListener('click', function() { showModal('reportModal') });
		closeModal.addEventListener('click', function() { hideModal('reportModal') });
		window.addEventListener('click', function(event) { if (event.target === modal) hideModal('reportModal') });

		reportForm.addEventListener('submit', function(e) {
			e.preventDefault();
			showCustomLoading();
			setTimeout(function() {
				hideCustomLoading();
				hideModal('reportModal');
				reportForm.reset();
				alert('Report submitted successfully. Your report has been sent to the Forest Department. Report ID: ENV-' + Date.now().toString().slice(-6) + '. Expected Response Time: 24-48 hours.');
			}, 1300);
		});

		function generateReportData() {
			const counts = document.querySelectorAll('.stat-number');
			return {
				totalClaims: parseInt(counts[0]?.textContent || '0') + parseInt(counts[1]?.textContent || '0') + parseInt(counts[2]?.textContent || '0') + parseInt(counts[3]?.textContent || '0'),
				approved: parseInt(counts[0]?.textContent || '0'),
				pending: parseInt(counts[1]?.textContent || '0'),
				review: parseInt(counts[2]?.textContent || '0'),
				rejected: parseInt(counts[3]?.textContent || '0'),
				deforestationAlerts: Math.floor(Math.random()*8)+3,
				highRiskAreas: Math.floor(Math.random()*5)+2,
				ndviViolations: Math.floor(Math.random()*12)+5
			};
		}

		function showCustomLoading(){ document.getElementById('loadingSpinner').style.display = 'block' }
		function hideCustomLoading(){ document.getElementById('loadingSpinner').style.display = 'none' }
		function showLoading(){ document.getElementById('loading').style.display = 'flex' }
		function hideLoading(){ document.getElementById('loading').style.display = 'none' }

		// Update dashboard counts based on loaded features
		function updateDashboardCounts(features){
			const counts = { approved:0, pending:0, review:0, rejected:0 };
			let totalFamilies = 0, totalArea = 0;
			features.forEach(f => {
				const status = (f.properties.status || '').toLowerCase();
				const families = f.properties.claimant_families || f.properties.claimants || 0;
				const area = f.properties.area_hectares || 0;
				totalFamilies += Number(families) || 0;
				totalArea += Number(area) || 0;
				if (status.includes('approved')) counts.approved++;
				else if (status.includes('pending')) counts.pending++;
				else if (status.includes('review')) counts.review++;
				else if (status.includes('reject')) counts.rejected++;
			});
			document.getElementById('approved-count').textContent = counts.approved;
			document.getElementById('pending-count').textContent = counts.pending;
			document.getElementById('review-count').textContent = counts.review;
			document.getElementById('rejected-count').textContent = counts.rejected;
			document.getElementById('last-update').textContent = 'Updated ' + new Date().toLocaleTimeString();
			document.getElementById('coverageInfo').textContent = `Coverage: ${new Set(features.map(f=>f.properties.state)).size || 1} States | ${features.length} Active Claims`;
		}

		// Try to load external GeoJSONs (preserve your files)
		(async function loadAllStateDatasets(){
			const stateFiles = [
				'assets/data/sample-claims.geojson',
				'assets/data/mp-claims.geojson',
				'assets/data/tripura-claims.geojson',
				'assets/data/telangana-claims.geojson'
			];
			const loadedFeatures = [];
			let successCount = 0;
			for (const file of stateFiles) {
				try {
					const resp = await fetch(file, { cache: 'no-store' });
					if (!resp.ok) throw new Error('HTTP ' + resp.status);
					const data = await resp.json();
					loadedFeatures.push(...(data.features || []));
					successCount++;
					console.log('Loaded', file, (data.features || []).length, 'claims');
				} catch (err) {
					console.warn('Could not load', file, err.message);
				}
			}
			if (loadedFeatures.length > 0) {
				claimsGroup.clearLayers();
				const allStatesData = { type:'FeatureCollection', features: loadedFeatures };
				const loaded = L.geoJSON(allStatesData, {
					style: claimStyle,
					onEachFeature: function(f, layer){
						// Build popup similar to fallback but include action placeholder
						const status = f.properties.status || 'Unknown';
						const name = f.properties.claim_id || f.properties.name || 'Claim';
						const area = (f.properties.area_hectares ? f.properties.area_hectares + ' ha' : (f.properties.area || '—'));
						const village = f.properties.village_name || f.properties.village || '—';
						const district = f.properties.district || '—';
						const state = f.properties.state || '—';
						const families = f.properties.claimant_families || f.properties.claimants || '—';
						const alertHTML = f.properties.deforestation_detected ? '<div style="color:#c0392b;font-weight:700;margin-top:8px;padding:6px;border-radius:6px;background:#fff5f5">DEFORESTATION ALERT</div>' : '<div style="color:#27ae60;font-weight:700;margin-top:8px">No Active Alerts</div>';
						const claimId = f.properties.claim_id || name;

						layer.bindPopup(`
							<div style="min-width:250px;font-family:inherit;">
								<h4 style="margin:0 0 10px 0;color:var(--accent-hex)">${name}</h4>
								<p><strong>State:</strong> ${state}</p>
								<p><strong>Village:</strong> ${village}</p>
								<p><strong>District:</strong> ${district}</p>
								<p><strong>Status:</strong> <span style="font-weight:700">${status}</span></p>
								<p><strong>Area:</strong> ${area}</p>
								<p><strong>Families:</strong> ${families}</p>
								${alertHTML}
								<div style="margin-top:10px" data-claim-id="${claimId}" class="action-area"></div>
							</div>
						`, { maxWidth:300, className:'custom-popup' });
					}
				});
				claimsGroup.addLayer(loaded);
				try { map.fitBounds(loaded.getBounds(), { padding:[50,50] }) } catch(e){ map.setView([20.5937,78.9629],6) }
				updateDashboardCounts(loadedFeatures);
				console.log(`Successfully loaded ${successCount}/${stateFiles.length} datasets with ${loadedFeatures.length} total claims`);
			} else {
				console.warn('Could not load external GeoJSON files, using built-in sample. Run a local server for full demo.');
				claimsGroup.addLayer(claimLayer);
				try{ map.fitBounds(claimLayer.getBounds(), { padding:[20,20] }) } catch(e){}
			}
		})();

		// When a popup opens, attach role-based action buttons (officials can change claim status)
		map.on('popupopen', function(e){
			const popupNode = e.popup.getElement ? e.popup.getElement() : null;
			if (!popupNode) return;
			const actionArea = popupNode.querySelector('.action-area');
			if (!actionArea) return;
			const claimId = actionArea.getAttribute('data-claim-id') || ('claim-' + Date.now());
			actionArea.innerHTML = ''; // clear

			// Always allow 'Report Issue' (citizen or official)
			const reportBtn = document.createElement('button');
			reportBtn.className = 'btn secondary';
			reportBtn.style.marginRight = '8px';
			reportBtn.textContent = 'Report Issue';
			reportBtn.addEventListener('click', () => {
				showModal('reportModal');
			});
			actionArea.appendChild(reportBtn);

			// If official, show approve/reject controls
			if (currentUser && currentUser.role === 'official') {
				const approveBtn = document.createElement('button');
				approveBtn.className = 'btn';
				approveBtn.style.background = 'linear-gradient(135deg, rgba(39,174,96,0.95), rgba(34,197,94,0.9))';
				approveBtn.style.marginRight = '8px';
				approveBtn.textContent = 'Approve';
				approveBtn.addEventListener('click', () => {
					updateClaimStatusByPopup(e.popup, claimId, 'Approved');
				});
				const rejectBtn = document.createElement('button');
				rejectBtn.className = 'btn';
				rejectBtn.style.background = 'linear-gradient(135deg, rgba(220,53,69,0.95), rgba(200,32,35,0.9))';
				rejectBtn.textContent = 'Reject';
				rejectBtn.addEventListener('click', () => {
					updateClaimStatusByPopup(e.popup, claimId, 'Rejected');
				});
				actionArea.appendChild(approveBtn);
				actionArea.appendChild(rejectBtn);
			} else {
				const info = document.createElement('div');
				info.style.fontSize = '12px';
				info.style.color = 'var(--muted)';
				info.style.marginTop = '8px';
				info.textContent = 'Log in as a Government Official to review claims.';
				actionArea.appendChild(info);
			}
		});

		// Update claim status given popup and claimId (in-memory only)
		function updateClaimStatusByPopup(popup, claimId, newStatus) {
			// find feature/layer with matching claim_id in claimsGroup
			let found = false;
			claimsGroup.eachLayer(function(groupLayer){
				// groupLayer may be a layerGroup containing geoJSON layers
				if (groupLayer.eachLayer) {
					groupLayer.eachLayer(function(layer){
						if (layer.feature && (layer.feature.properties.claim_id === claimId || layer.feature.properties.name === claimId)) {
							layer.feature.properties.status = newStatus;
							layer.setStyle(claimStyle(layer.feature));
							found = true;
						}
					});
				} else if (groupLayer.feature) {
					if (groupLayer.feature.properties.claim_id === claimId || groupLayer.feature.properties.name === claimId) {
						groupLayer.feature.properties.status = newStatus;
						groupLayer.setStyle(claimStyle(groupLayer.feature));
						found = true;
					}
				}
			});
			if (found) {
				// rebuild counts from all features
				const allFeatures = [];
				claimsGroup.eachLayer(function(gl){
					if (gl.getLayers) {
						gl.getLayers().forEach(l => l.feature && allFeatures.push(l.feature));
					} else if (gl.feature) {
						allFeatures.push(gl.feature);
					}
				});
				updateDashboardCounts(allFeatures);
				alert('Claim ' + claimId + ' status updated to ' + newStatus + '.');
				popup._source && popup._source.closePopup && popup._source.closePopup();
			} else {
				alert('Unable to find claim to update. For production, perform updates via your API.');
			}
		}

		// initial guidance popup (try to open first popup)
		setTimeout(function(){
			try {
				var any = claimsGroup.getLayers()[0];
				var inner = any && any.getLayers ? any.getLayers()[0] : any;
				if (inner && inner.openPopup) inner.openPopup();
			} catch(e){}
		}, 1400);

		// small helpers and console messages (no emojis)
		console.log("FRA Atlas DSS loaded.");
		console.log("Multi-state monitoring: Odisha, MP, Tripura, Telangana.");

		// helper for status color used in earlier popups (when building strings)
		function getStatusColor(status) {
			const s = (status||'').toLowerCase();
			if (s.includes('approved')) return '#27ae60';
			if (s.includes('pending')) return '#f39c12';
			if (s.includes('review')) return '#8e44ad';
			if (s.includes('reject')) return '#c0392b';
			return '#34495e';
		}
	</script>
</body>
</html>
