<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VisionForge — FRA Atlas DSS</title>

<!-- Keep your same external links (unchanged) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<!-- marker cluster & heat -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  :root{
    --bg-r: 18; --bg-g: 20; --bg-b: 28;
    --card-radius: 12px;
    --accent-1: #0f766e;   /* VisionForge primary */
    --accent-2: #10b981;
    --muted: #9aa3ab;
    --glass-dark: rgba(255,255,255,0.02);
    --glass-light: rgba(255,255,255,0.94);
    --input-bg-dark: rgba(255,255,255,0.03);
    --input-text-dark: #e6eef8;
    --input-bg-light: #ffffff;
    --input-text-light: #0b1220;
    --btn-text-light: #ffffff;
  }

  body[data-theme="light"]{
    --bg-r: 245; --bg-g: 247; --bg-b: 250;
    --muted: #4b5563;
    --input-bg-dark: #ffffff;
    --input-text-dark: #0b1220;
    --glass-dark: rgba(0,0,0,0.02);
  }

  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:'Inter',system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    background:
      radial-gradient(900px 400px at 10% 10%, rgba(16,185,129,0.03), transparent),
      rgb(var(--bg-r),var(--bg-g),var(--bg-b));
    color:var(--input-text-dark);
    -webkit-font-smoothing:antialiased;
    height:100vh;
    overflow:hidden;
  }

  /* header */
  .header{
    display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px;margin:14px;border-radius:12px;
    background: linear-gradient(180deg, var(--glass-dark), rgba(255,255,255,0.02));
    backdrop-filter: blur(8px) saturate(120%);
    box-shadow: 0 8px 30px rgba(0,0,0,0.35);
    border:1px solid rgba(255,255,255,0.03);
  }
  .brand{display:flex;align-items:center;gap:12px}
  .logo-mark{width:54px;height:54px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg, rgba(16,185,129,0.08), rgba(255,255,255,0.02));border:1px solid rgba(0,0,0,0.06)}
  .logo-mark i{color:var(--accent-1);font-size:20px}
  .title h1{
    font-size:18px;
    margin-bottom:2px;
    background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
    -webkit-background-clip: text; background-clip: text; color: transparent;
    font-weight:800;
  }
  .title p{font-size:12px;color:var(--muted);margin:0;max-width:360px}

  .header-controls{display:flex;align-items:center;gap:10px}
  .btn{
    padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700;display:inline-flex;align-items:center;gap:8px;
    background:linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    color:var(--btn-text-light);
    backdrop-filter: blur(4px);
    border:1px solid rgba(255,255,255,0.03);
  }
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--input-text-dark)}
  .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,0.03)}
  .btn:focus{outline:2px solid rgba(0,0,0,0.06)}
  .auth-controls{display:flex;gap:8px;align-items:center}

  /* layout */
  .main-container{display:flex;height:calc(100vh - 120px);margin:14px;gap:18px}
  #map{flex:1;border-radius:16px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.02);position:relative}
  .dashboard{width:400px;padding:18px;border-radius:var(--card-radius);backdrop-filter:blur(8px);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.008));border:1px solid rgba(255,255,255,0.02);box-shadow:0 20px 60px rgba(0,0,0,0.45);overflow:auto}

  .dashboard-section{margin-bottom:16px;padding:14px;border-radius:10px;background:linear-gradient(180deg, rgba(0,0,0,0.14), rgba(0,0,0,0.05));border:1px solid rgba(255,255,255,0.02)}
  .section-title{display:flex;align-items:center;gap:8px;margin-bottom:10px}
  .section-title h3{font-size:14px;color:var(--accent-1)}
  .section-title p{font-size:12px;color:var(--muted);margin-left:auto}

  .stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .stat-card{padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02);text-align:center}
  .stat-number{font-size:20px;font-weight:800;color:var(--input-text-dark)}
  .stat-label{font-size:12px;color:var(--muted);margin-top:6px;text-transform:uppercase;letter-spacing:0.6px}

  /* inputs / selects - theme aware */
  input[type="text"], input[type="email"], input[type="password"], textarea, select, .form-control, input[list], .range {
    background: var(--input-bg-dark);
    color: var(--input-text-dark);
    border: 1px solid rgba(0,0,0,0.08);
    padding:10px 12px;border-radius:8px;font-size:14px;
  }
  body[data-theme="light"] input[type="text"], body[data-theme="light"] textarea, body[data-theme="light"] select, body[data-theme="light"] .form-control { background: var(--input-bg-light); color: var(--input-text-light); border:1px solid rgba(0,0,0,0.08) }

  .search-row{display:flex;gap:8px;margin-bottom:10px}
  .search-row input{flex:1}
  .search-row select{padding:10px;border-radius:8px}

  .small{font-size:12px;color:var(--muted)}

  .legend{position:absolute;bottom:22px;left:22px;padding:12px;border-radius:10px;z-index:1100;background:linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.28));border:1px solid rgba(255,255,255,0.04)}
  .legend h4{margin:0 0 10px 0;color:var(--accent-1)}
  .legend-item{display:flex;gap:10px;align-items:center;color:var(--input-text-dark);margin-bottom:8px}

  .leaflet-popup-content-wrapper{border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,0.3)}

  /* compare */
  .compare-container{position:absolute;top:80px;right:40px;width:560px;height:360px;z-index:1400;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.5);backdrop-filter:blur(6px)}
  .compare-bottom, .compare-top{position:absolute;left:0;top:0;height:100%;width:100%;overflow:hidden}
  .compare-top{width:50%}
  .compare-bottom img, .compare-top img{width:100%;height:100%;object-fit:cover;display:block}
  .compare-divider{position:absolute;left:50%;top:0;height:100%;width:4px;margin-left:-2px;background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.6));cursor:ew-resize;box-shadow:0 4px 12px rgba(0,0,0,0.4)}

  /* timeline */
  .timeline-controls{display:flex;gap:8px;align-items:center;margin-top:8px}
  .range{flex:1}

  /* role actions */
  .role-actions{display:flex;gap:8px;margin-bottom:12px;align-items:center}
  .role-actions .btn{flex:1}

  /* modal */
  .modal{display:none;position:fixed;z-index:1600;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.45);align-items:center;justify-content:center}
  .modal.open{display:flex}
  .modal-card{width:94%;max-width:720px;border-radius:14px;overflow:hidden;background:linear-gradient(180deg,#fff,#fafafa);color:#111;box-shadow:0 30px 70px rgba(0,0,0,0.5)}
  .modal-header{padding:16px 18px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(0,0,0,0.06)}
  .modal-body{padding:16px 18px;max-height:75vh;overflow:auto}
  .form-group{margin-bottom:12px}
  .form-control{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.08)}
  @media(max-width:900px){ .dashboard{ display:none } }

  /* smaller adjustments */
  .btn[disabled]{opacity:0.6;cursor:not-allowed}
  a{color:var(--accent-1);text-decoration:none}
</style>
</head>
<body data-theme="dark">

<header class="header">
  <div class="brand">
    <div class="logo-mark"><i class="fas fa-cube"></i></div>
    <div class="title">
      <h1>VisionForge</h1>
      <p>AI-powered FRA Atlas & WebGIS — Satellite + Community evidence for fair forest rights.</p>
    </div>
  </div>

  <div class="header-controls">
    <div style="display:flex;gap:10px;align-items:center;margin-right:8px">
      <div class="small">Sentinel-2 Connected</div>
      <div class="small">4 States Loaded</div>
    </div>

    <div class="auth-controls">
      <button id="themeToggle" class="btn secondary">Theme</button>
      <button id="aboutBtn" class="btn ghost">About</button>
      <button id="loginOpen" class="btn">Login</button>
      <div id="userPanel" style="display:none;align-items:center;gap:8px;">
        <div id="userBadge" class="btn" style="pointer-events:none"></div>
        <button id="logoutBtn" class="btn secondary">Logout</button>
      </div>
    </div>
  </div>
</header>

<div class="main-container">
  <div id="map"></div>

  <aside class="dashboard" aria-label="Control dashboard">
    <div class="dashboard-section">
      <div class="section-title">
        <h3>FRA Claims Overview</h3>
        <p id="coverageInfo">Coverage: 4 States</p>
      </div>

      <!-- role actions -->
      <div class="role-actions" id="roleActionsBox" style="display:none"></div>

      <div class="search-row">
        <input id="searchInput" placeholder="Search claim id / village / district / state" list="autocompleteList" />
        <datalist id="autocompleteList"></datalist>
        <select id="statusFilter">
          <option value="all">All statuses</option>
          <option value="approved">Approved</option>
          <option value="pending">Pending</option>
          <option value="review">Under Review</option>
          <option value="rejected">Rejected</option>
        </select>
      </div>

      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button id="saveFilterBtn" class="btn secondary" style="flex:1">Save Filter</button>
        <select id="savedFilters" class="form-control" style="flex:1;padding:10px;border-radius:8px"></select>
      </div>

      <div class="stat-grid">
        <div class="stat-card"><div class="stat-number" id="approved-count">1,247</div><div class="stat-label">Approved</div></div>
        <div class="stat-card"><div class="stat-number" id="pending-count">156</div><div class="stat-label">Pending</div></div>
        <div class="stat-card"><div class="stat-number" id="review-count">43</div><div class="stat-label">Under Review</div></div>
        <div class="stat-card"><div class="stat-number" id="rejected-count">12</div><div class="stat-label">Rejected</div></div>
      </div>

      <div style="margin-top:12px;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(0,0,0,0.06), rgba(0,0,0,0.02));font-size:13px;color:var(--muted)">
        <strong>Live Updates:</strong> <span id="last-update">Real-time monitoring active</span>
      </div>
    </div>

    <div class="dashboard-section">
      <div class="section-title"><h3>Satellite Monitoring</h3><p>NDVI overlays & timeline</p></div>

      <div style="display:flex;gap:8px">
        <button id="beforeBtn" class="btn" style="background:linear-gradient(135deg,#2ecc71,#27ae60);color:var(--btn-text-light)">Baseline</button>
        <button id="afterBtn" class="btn" style="background:linear-gradient(135deg,#ef4444,#c026d3);color:var(--btn-text-light)">Current</button>
        <button id="toggleTimelineOverlay" class="btn secondary">Toggle NDVI</button>
      </div>

      <div style="margin-top:12px">
        <div class="timeline-controls">
          <!-- Single Play/Pause toggle -->
          <button id="playPauseBtn" class="btn" style="background:linear-gradient(135deg,#10b981,#06b6d4);color:var(--btn-text-light)">Play</button>

          <input id="timelineRange" class="range" type="range" min="0" max="4" step="1" value="0" />

          <!-- Styled and visible timeline speed -->
          <select id="timelineSpeed" class="form-control" style="width:92px;">
            <option value="1200">1x</option>
            <option value="800">1.5x</option>
            <option value="400">2x</option>
          </select>
        </div>
        <div style="margin-top:8px">
          <label class="small">NDVI Opacity</label>
          <input id="ndviOpacity" type="range" min="0" max="1" step="0.05" value="0.6" />
        </div>
      </div>
    </div>

    <div class="dashboard-section">
      <div class="section-title"><h3>Visual Tools</h3><p>Cluster / Heatmap / Compare</p></div>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button id="toggleCluster" class="btn">Show Clusters</button>
        <button id="toggleHeatmap" class="btn">Show Heatmap</button>
      </div>
      <div style="display:flex;gap:8px">
        <button id="compareOpen" class="btn secondary">Open Compare</button>
        <button id="exportBtn" class="btn" style="background:linear-gradient(135deg,#10b981,#06b6d4);color:var(--btn-text-light)">Generate Report</button>
      </div>
    </div>
  </aside>
</div>

<!-- Compare floating panel -->
<div id="compareContainer" class="compare-container" style="display:none">
  <div class="compare-bottom"><img id="compareBefore" src="" alt="before"/></div>
  <div id="compareTop" class="compare-top"><img id="compareAfter" src="" alt="after"/></div>
  <div id="divider" class="compare-divider"></div>
</div>

<!-- Legend -->
<div class="legend">
  <h4>Map Legend</h4>
  <div class="legend-item"><div class="legend-color" style="width:18px;height:18px;background-color:#ff7800;border-radius:4px;border:2px solid rgba(0,0,0,0.15)"></div><div>FRA Claim Boundary</div></div>
  <div class="legend-item"><div class="legend-color" style="width:18px;height:18px;background-color:#4CAF50;opacity:0.8;border-radius:4px;border:2px solid rgba(0,0,0,0.15)"></div><div>Healthy Vegetation (High NDVI)</div></div>
  <div class="legend-item"><div class="legend-color" style="width:18px;height:18px;background-color:#ff6b6b;opacity:0.8;border-radius:4px;border:2px solid rgba(0,0,0,0.15)"></div><div>Forest Loss (Low NDVI)</div></div>
</div>

<!-- Report Modal -->
<div id="reportModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-header"><h3 style="margin:0">Report Environmental Issue</h3><button class="close" id="closeReport">&times;</button></div>
    <div class="modal-body">
      <form id="reportForm">
        <div class="form-group"><label>Issue Type *</label><select id="issueType" class="form-control"><option>Illegal Deforestation</option><option>Encroachment</option><option>Unauthorized Mining</option><option>Waste Dumping</option></select></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div class="form-group"><label>Your Name</label><input id="reportName" class="form-control" required/></div>
          <div class="form-group"><label>Phone</label><input id="reportPhone" class="form-control"/></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div class="form-group"><label>Location / Village</label><input id="reportLocation" class="form-control" required/></div>
          <div class="form-group"><label>District</label><input id="reportDistrict" class="form-control" required/></div>
        </div>
        <div class="form-group"><label>Description</label><textarea id="reportDesc" class="form-control" required></textarea></div>
        <div style="display:flex;gap:8px"><button type="submit" class="btn" style="flex:1;background:linear-gradient(135deg,#10b981,#06b6d4);color:var(--btn-text-light)">Submit</button><button type="button" id="reportCancel" class="btn secondary" style="flex:1">Cancel</button></div>
      </form>
    </div>
  </div>
</div>

<!-- Polished Login modal -->
<div id="loginModal" class="modal" aria-hidden="true">
  <div class="modal-card" style="max-width:820px">
    <div class="modal-header"><h3 style="margin:0">Sign in to VisionForge</h3><button class="close" id="closeLogin">&times;</button></div>
    <div class="modal-body" style="padding:0">
      <div style="display:grid;grid-template-columns:1fr 1fr;min-height:320px">
        <div style="padding:22px;background:linear-gradient(180deg, rgba(16,185,129,0.06), rgba(15,118,110,0.02));display:flex;flex-direction:column;align-items:center;justify-content:center">
          <h3 style="color:var(--accent-1);margin:0 0 8px 0">Welcome</h3>
          <p style="max-width:260px;color:var(--muted);text-align:center">Secure access for Citizens and Government Officials. Use Demo mode for prototyping; add backend or Firebase later.</p>
          <div style="margin-top:16px;display:flex;gap:8px">
            <div style="background:linear-gradient(135deg,var(--accent-1),var(--accent-2));padding:8px;border-radius:8px;color:#fff;font-weight:700">Secure</div>
            <div style="background:linear-gradient(135deg,#2563eb,#7c3aed);padding:8px;border-radius:8px;color:#fff;font-weight:700">Auditable</div>
          </div>
        </div>

        <div style="padding:18px;background: #fff;">
          <form id="loginForm" style="display:grid;gap:10px;color:#111">
            <div class="form-group"><label>Login As</label><select id="roleSelect" class="form-control"><option value="citizen">Citizen</option><option value="official">Government Official</option></select></div>
            <div class="form-group"><label>Email</label><input id="username" class="form-control" type="email" placeholder="you@example.com" required/></div>
            <div class="form-group"><label>Password</label><input id="password" class="form-control" type="password" placeholder="password" required/></div>
            <div style="display:flex;gap:8px;align-items:center">
              <button type="submit" class="btn" style="flex:1;background:linear-gradient(135deg,#3b82f6,#2563eb);color:var(--btn-text-light)">Sign in</button>
              <button type="button" id="loginDemo" class="btn secondary" style="flex:1">Demo</button>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
              <label style="font-size:13px;color:var(--muted)"><input id="rememberMe" type="checkbox" style="margin-right:8px"> Remember me</label>
              <a href="#" style="font-size:13px">Need help?</a>
            </div>
            <p class="small" style="margin-top:6px">Demo: sign in with any credentials. Firebase is optional — fill firebaseConfig later.</p>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- About modal -->
<div id="aboutModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-header"><h3 style="margin:0">About VisionForge</h3><button class="close" id="closeAbout">&times;</button></div>
    <div class="modal-body">
      <p style="color:#111">VisionForge — an AI & WebGIS decision support prototype for FRA monitoring across Madhya Pradesh, Tripura, Odisha, and Telangana. Multi-state claim loading, NDVI visualization, reporting, and officer-review flows are included. Integrate your backend when ready.</p>
    </div>
  </div>
</div>

<!-- Leaflet & plugins (same links preserved) -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script>
/* ===========================
   Firebase placeholder - leave null for now
   =========================== */
const firebaseConfig = null;
let useFirebase = false;
if (firebaseConfig) {
  try { /* initialize firebase here if provided */ useFirebase = true; } catch(e){ console.warn('Firebase init failed', e); }
}

/* Application state */
let currentUser = null; // {username, role}
const layerMap = new Map(); // id -> L.geoJSON layer
let clusterGroup = null, heatmapLayer = null;
let timelineTimer = null;
let timelineIndex = 0;
const ndviImages = []; // generated images
const ndviOverlays = [];

/* DOM refs (cached) */
const loginOpen = document.getElementById('loginOpen');
const loginModal = document.getElementById('loginModal');
const closeLogin = document.getElementById('closeLogin');
const loginForm = document.getElementById('loginForm');
const loginDemo = document.getElementById('loginDemo');
const roleSelect = document.getElementById('roleSelect');
const userPanel = document.getElementById('userPanel');
const userBadge = document.getElementById('userBadge');
const logoutBtn = document.getElementById('logoutBtn');

const aboutBtn = document.getElementById('aboutBtn');
const aboutModal = document.getElementById('aboutModal');
const closeAbout = document.getElementById('closeAbout');

const reportModal = document.getElementById('reportModal');
const closeReport = document.getElementById('closeReport');
const reportForm = document.getElementById('reportForm');
const reportCancel = document.getElementById('reportCancel');

const themeToggle = document.getElementById('themeToggle');

const searchInput = document.getElementById('searchInput');
const autoList = document.getElementById('autocompleteList');
const statusFilter = document.getElementById('statusFilter');
const saveFilterBtn = document.getElementById('saveFilterBtn');
const savedFilters = document.getElementById('savedFilters');

const beforeBtn = document.getElementById('beforeBtn');
const afterBtn = document.getElementById('afterBtn');
const toggleTimelineOverlay = document.getElementById('toggleTimelineOverlay');
const playPauseBtn = document.getElementById('playPauseBtn');
const timelineRange = document.getElementById('timelineRange');
const timelineSpeed = document.getElementById('timelineSpeed');
const ndviOpacity = document.getElementById('ndviOpacity');

const toggleClusterBtn = document.getElementById('toggleCluster');
const toggleHeatmapBtn = document.getElementById('toggleHeatmap');

const compareOpen = document.getElementById('compareOpen');
const compareContainer = document.getElementById('compareContainer');
const compareBefore = document.getElementById('compareBefore');
const compareAfter = document.getElementById('compareAfter');
const compareTop = document.getElementById('compareTop');
const divider = document.getElementById('divider');

const roleActionsBox = document.getElementById('roleActionsBox');
const exportBtn = document.getElementById('exportBtn');

/* show/hide helpers */
function showModal(node){ node.classList.add('open'); node.style.display='flex'; node.setAttribute('aria-hidden','false'); }
function hideModal(node){ node.classList.remove('open'); node.style.display='none'; node.setAttribute('aria-hidden','true'); }

/* header wiring */
loginOpen.addEventListener('click', ()=> showModal(loginModal));
closeLogin.addEventListener('click', ()=> hideModal(loginModal));
aboutBtn.addEventListener('click', ()=> showModal(aboutModal));
closeAbout.addEventListener('click', ()=> hideModal(aboutModal));
closeReport && closeReport.addEventListener('click', ()=> hideModal(reportModal));
reportCancel && reportCancel.addEventListener('click', ()=> hideModal(reportModal));
themeToggle.addEventListener('click', ()=> {
  const b = document.body; const cur = b.getAttribute('data-theme') || 'dark'; b.setAttribute('data-theme', cur === 'dark' ? 'light' : 'dark');
});

/* Map initialization (unchanged links) */
const map = L.map('map', { center:[20.2961,85.8245], zoom:12, zoomControl:true });
L.control.zoom({ position:'topright' }).addTo(map);
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap', maxZoom:18 }).addTo(map);
const positron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution:'&copy; CARTO & OpenStreetMap', maxZoom:19 });
L.control.layers({ "OpenStreetMap": osm, "Positron (Light)": positron }, {}, { position:'topright', collapsed:true }).addTo(map);

/* fallback sample feature (unchanged properties; emoji removed) */
const fallbackFeature = {
  "type":"Feature","properties":{"name":"CFR-2024-OD-101","village":"Khandagiri","district":"Khurda","area":"245 hectares","status":"Approved","claimants":"127 families","approval_date":"2024-03-15","claim_id":"CFR-2024-OD-101","state":"Odisha","deforestation_detected":true,"area_hectares":245,"claimant_families":127},
  "geometry":{"type":"Polygon","coordinates":[[[85.8100,20.3100],[85.8300,20.3100],[85.8300,20.2900],[85.8100,20.2900],[85.8100,20.3100]]]}
};

/* styling and popup builder (no emojis) */
function claimStyle(feature){
  const props = feature.properties||{};
  const s = (props.status||'').toLowerCase();
  let color = '#ff7800';
  if (s.includes('pending')) color = '#f1c40f';
  else if (s.includes('reject')||s.includes('rejected')) color = '#c0392b';
  else if (s.includes('review')) color = '#8e44ad';
  else if (s.includes('approved')) color = '#27ae60';
  const hasAlert = !!props.deforestation_detected;
  return { color: hasAlert ? '#e74c3c' : color, weight: hasAlert?3.5:2.5, fillColor:color, fillOpacity:hasAlert?0.4:0.18, dashArray:hasAlert?'5,5':null };
}
function buildPopup(feature){
  const p = feature.properties || {};
  const name = p.claim_id || p.name || 'Claim';
  const status = p.status || 'Unknown';
  const area = (p.area_hectares ? p.area_hectares + ' ha' : (p.area||'—'));
  const village = p.village_name || p.village || '—';
  const district = p.district || '—';
  const state = p.state || '—';
  const families = p.claimant_families || p.claimants || '—';
  const alertHTML = p.deforestation_detected ? '<div style="color:#c0392b;font-weight:700;margin-top:8px;padding:6px;border-radius:6px;background:#fff5f5">DEFORESTATION ALERT</div>' : '<div style="color:#27ae60;font-weight:700;margin-top:8px">No Active Alerts</div>';
  const claimId = p.claim_id || name;
  return `
    <div style="min-width:260px;font-family:inherit;">
      <h4 style="margin:0 0 8px 0;color:var(--accent-1)">${name}</h4>
      <p style="margin:4px 0"><strong>State:</strong> ${state}</p>
      <p style="margin:4px 0"><strong>Village:</strong> ${village}</p>
      <p style="margin:4px 0"><strong>District:</strong> ${district}</p>
      <p style="margin:4px 0"><strong>Status:</strong> <span style="font-weight:700">${status}</span></p>
      <p style="margin:4px 0"><strong>Area:</strong> ${area}</p>
      <p style="margin:4px 0"><strong>Families:</strong> ${families}</p>
      ${alertHTML}
      <div style="margin-top:10px" data-claim-id="${claimId}" class="action-area"></div>
    </div>
  `;
}

/* add feature & track layer */
function addFeature(feature){
  const layer = L.geoJSON(feature, {
    style: claimStyle,
    onEachFeature: (f,l) => { l.bindPopup(buildPopup(f), { maxWidth:350, className:'custom-popup' }); }
  });
  const id = feature.properties && (feature.properties.claim_id || feature.properties.name) || ('claim-'+Date.now());
  layerMap.set(id, layer);
  layer.addTo(map);
}
addFeature(fallbackFeature);

/* create higher-res NDVI images (avoids pixelated blocks) */
function createHighResNDVI(type, seed){
  const W = 1600, H = 1000;
  const c = document.createElement('canvas'); c.width = W; c.height = H;
  const ctx = c.getContext('2d');
  if (type === 'healthy') {
    const g = ctx.createLinearGradient(0,0,W,H); g.addColorStop(0,'rgba(34,197,94,1)'); g.addColorStop(1,'rgba(16,185,129,1)');
    ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
    ctx.globalAlpha = 0.03;
    ctx.fillStyle = '#000';
    for (let i=0;i<400;i++){ ctx.fillRect(Math.random()*W, Math.random()*H, Math.random()*3, Math.random()*3) }
    ctx.globalAlpha = 1;
  } else if (type === 'mixed') {
    ctx.fillStyle = 'rgba(34,197,94,0.9)'; ctx.fillRect(0,0,W,H);
    ctx.fillStyle = 'rgba(244,67,54,0.85)';
    for (let i=0;i<14;i++){ ctx.fillRect(60 + (i*110 + (seed*17)%80), 60 + ((i*45 + seed*7)%220), 70 + (seed%40), 40 + ((i*23)%60)) }
  } else {
    ctx.fillStyle = 'rgba(76,175,80,0.6)'; ctx.fillRect(0,0,W,H);
    ctx.fillStyle = 'rgba(244,67,54,0.95)';
    for (let i=0;i<26;i++){ ctx.fillRect(30 + (i*55 + (seed*31)%120), 30 + ((i*30 + seed*19)%280), 100, 70) }
  }
  return c.toDataURL('image/png', 0.9);
}

/* build timeline images (0..4) */
for (let t=0;t<=4;t++){
  if (t <= 1) ndviImages.push(createHighResNDVI('healthy', t));
  else if (t === 2) ndviImages.push(createHighResNDVI('mixed', t));
  else ndviImages.push(createHighResNDVI('degraded', t));
}

/* create image overlays (store, don't add) */
const imageBounds = [[20.2900,85.8100],[20.3100,85.8300]];
ndviImages.forEach(img => {
  const o = L.imageOverlay(img, imageBounds, { opacity: Number(ndviOpacity.value) });
  ndviOverlays.push(o);
});

/* helper to set timeline overlay */
function setTimelineOverlay(idx){
  ndviOverlays.forEach(o => { if (map.hasLayer(o)) map.removeLayer(o); });
  if (ndviOverlays[idx]) ndviOverlays[idx].addTo(map);
  timelineRange.max = Math.max(0, ndviOverlays.length - 1);
  timelineRange.value = idx;
}

/* initial overlays are off */
ndviOverlays.forEach(o => { if (map.hasLayer(o)) map.removeLayer(o); });

/* single play/pause button logic */
let playing = false;
function startTimeline(){
  const speed = Number(timelineSpeed.value) || 1200;
  if (timelineTimer) clearInterval(timelineTimer);
  timelineTimer = setInterval(()=>{
    timelineIndex = (timelineIndex + 1) % ndviOverlays.length;
    setTimelineOverlay(timelineIndex);
  }, speed);
  playing = true;
  playPauseBtn.textContent = 'Pause';
  playPauseBtn.style.background = 'linear-gradient(135deg,#ef4444,#dc2626)';
}
function stopTimeline(){
  if (timelineTimer) clearInterval(timelineTimer);
  timelineTimer = null;
  playing = false;
  playPauseBtn.textContent = 'Play';
  playPauseBtn.style.background = 'linear-gradient(135deg,#10b981,#06b6d4)';
}
playPauseBtn.addEventListener('click', ()=> { if (playing) stopTimeline(); else startTimeline(); });

timelineRange.addEventListener('input', (e)=> { timelineIndex = Number(e.target.value); setTimelineOverlay(timelineIndex); });
timelineSpeed.addEventListener('change', ()=> { if (playing) { startTimeline(); } });

/* before/after/toggle controls */
let ndviShown = false;
beforeBtn.addEventListener('click', ()=> { setTimelineOverlay(0); ndviShown = true; });
afterBtn.addEventListener('click', ()=> { setTimelineOverlay(ndviOverlays.length - 1); ndviShown = true; });
toggleTimelineOverlay.addEventListener('click', ()=> {
  ndviShown = !ndviShown;
  if (!ndviShown) ndviOverlays.forEach(o => map.removeLayer(o));
  else setTimelineOverlay(timelineIndex || 0);
});

/* NDVI opacity */
ndviOpacity.addEventListener('input', (e)=> {
  const v = Number(e.target.value);
  ndviOverlays.forEach(o => o.setOpacity(v));
});

/* Compare open/close and divider drag */
compareOpen.addEventListener('click', ()=> {
  if (!compareContainer.style.display || compareContainer.style.display === 'none') {
    compareBefore.src = ndviImages[0];
    compareAfter.src = ndviImages[ndviImages.length - 1];
    compareContainer.style.display = 'block';
    compareTop.style.width = '50%';
    divider.style.left = '50%';
  } else {
    compareContainer.style.display = 'none';
  }
});
let dragging = false;
divider.addEventListener('mousedown', (e)=> { dragging = true; e.preventDefault(); });
document.addEventListener('mouseup', ()=> dragging = false);
document.addEventListener('mousemove', (e)=>{
  if (!dragging) return;
  const rect = compareContainer.getBoundingClientRect();
  let x = e.clientX - rect.left;
  if (x < 0) x = 0;
  if (x > rect.width) x = rect.width;
  const pct = (x/rect.width)*100;
  compareTop.style.width = pct + '%';
  divider.style.left = pct + '%';
});

/* cluster & heat rebuild */
function rebuildClusterAndHeat(){
  const markers = L.markerClusterGroup();
  const heatPoints = [];
  layerMap.forEach(layer => {
    const inner = layer.getLayers ? layer.getLayers()[0] : layer;
    if (!inner) return;
    const bounds = inner.getBounds ? inner.getBounds() : null;
    if (!bounds) return;
    const c = bounds.getCenter();
    const feat = inner.feature || inner;
    const marker = L.marker([c.lat, c.lng]);
    marker.bindPopup(`<div style="min-width:180px"><strong>${feat.properties.claim_id||feat.properties.name||'Claim'}</strong><div style="font-size:12px;color:var(--muted)">Status: ${feat.properties.status||'—'}</div></div>`);
    markers.addLayer(marker);
    heatPoints.push([c.lat, c.lng, feat.properties.deforestation_detected ? 0.9 : 0.4]);
  });
  if (clusterGroup) map.removeLayer(clusterGroup);
  clusterGroup = markers;
  if (heatmapLayer) map.removeLayer(heatmapLayer);
  heatmapLayer = L.heatLayer(heatPoints, { radius: 25, blur: 20, maxZoom: 12 });
}
let clusterShown=false, heatShown=false;
toggleClusterBtn.addEventListener('click', ()=> {
  if (!clusterGroup) rebuildClusterAndHeat();
  clusterShown = !clusterShown;
  if (clusterShown) clusterGroup.addTo(map); else map.removeLayer(clusterGroup);
  toggleClusterBtn.textContent = clusterShown ? 'Hide Clusters' : 'Show Clusters';
});
toggleHeatmapBtn.addEventListener('click', ()=> {
  if (!heatmapLayer) rebuildClusterAndHeat();
  heatShown = !heatShown;
  if (heatShown) heatmapLayer.addTo(map); else map.removeLayer(heatmapLayer);
  toggleHeatmapBtn.textContent = heatShown ? 'Hide Heatmap' : 'Show Heatmap';
});

/* popup open actions (role-based) - no emojis */
map.on('popupopen', (e)=>{
  const popupEl = e.popup.getElement && e.popup.getElement();
  if (!popupEl) return;
  const actionArea = popupEl.querySelector('.action-area');
  if (!actionArea) return;
  actionArea.innerHTML = '';
  const claimId = actionArea.getAttribute('data-claim-id');
  const reportBtn = document.createElement('button'); reportBtn.className='btn secondary'; reportBtn.textContent='Report'; reportBtn.onclick = ()=> showModal(reportModal);
  actionArea.appendChild(reportBtn);
  if (currentUser && currentUser.role === 'official') {
    const approve = document.createElement('button'); approve.className='btn'; approve.style.background='linear-gradient(135deg,#2ecc71,#27ae60)'; approve.textContent='Approve';
    const reject = document.createElement('button'); reject.className='btn'; reject.style.background='linear-gradient(135deg,#ef4444,#dc2626)'; reject.textContent='Reject';
    approve.onclick = ()=> updateClaimStatus(claimId, 'Approved', e.popup);
    reject.onclick = ()=> updateClaimStatus(claimId, 'Rejected', e.popup);
    actionArea.appendChild(approve); actionArea.appendChild(reject);
  } else {
    const hint = document.createElement('div'); hint.className='small'; hint.style.marginTop='6px'; hint.textContent='Log in as an official to review claims.';
    actionArea.appendChild(hint);
  }
});

/* update claim status locally and try to persist (demo) */
async function updateClaimStatus(claimId, newStatus, popup){
  let found=false;
  layerMap.forEach((layer,id)=>{
    if (id === claimId) {
      const inner = layer.getLayers ? layer.getLayers()[0] : layer;
      if (inner && inner.feature) {
        inner.feature.properties.status = newStatus;
        layer.setStyle && layer.setStyle(claimStyle(inner.feature));
        found = true;
      }
    }
  });
  try {
    if (useFirebase) {
      // persist to Firestore when configured
    } else {
      fetch('/api/claims/update', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ claimId, status:newStatus }) })
        .catch(()=>{/* ignore in demo */});
    }
  } catch(e){ console.warn(e) }
  // update counts
  const allFeatures = [];
  layerMap.forEach(l => {
    const inner = l.getLayers ? l.getLayers()[0] : l;
    if (inner && inner.feature) allFeatures.push(inner.feature);
  });
  updateDashboardCounts(allFeatures);
  if (found) { alert('Claim ' + claimId + ' updated to ' + newStatus); popup && popup._source && popup._source.closePopup && popup._source.closePopup(); }
  else alert('Could not find claim locally (demo).');
}

/* search autocomplete & saved filters */
function rebuildAutocomplete(){
  const vals = new Set();
  layerMap.forEach((layer,id)=>{
    const inner = layer.getLayers ? layer.getLayers()[0] : layer;
    if (!inner || !inner.feature) return;
    const p = inner.feature.properties || {};
    if (p.claim_id) vals.add(p.claim_id);
    if (p.village) vals.add(p.village);
    if (p.district) vals.add(p.district);
    if (p.state) vals.add(p.state);
  });
  autoList.innerHTML = '';
  Array.from(vals).slice(0,300).forEach(v => {
    const opt = document.createElement('option'); opt.value = v; autoList.appendChild(opt);
  });
}

function applySearchFilter(){
  const q = (searchInput.value||'').trim().toLowerCase();
  const status = statusFilter.value;
  // remove all layers then add matches
  layerMap.forEach(layer => map.removeLayer(layer));
  const matched = [];
  layerMap.forEach((layer,id) => {
    const inner = layer.getLayers ? layer.getLayers()[0] : layer;
    if (!inner || !inner.feature) return;
    const p = inner.feature.properties || {};
    const combined = `${p.claim_id||''} ${p.village||p.village_name||''} ${p.district||''} ${p.state||''} ${p.status||''}`.toLowerCase();
    const matchesQ = !q || combined.includes(q);
    const matchesStatus = (status === 'all') || ((p.status||'').toLowerCase().includes(status));
    if (matchesQ && matchesStatus) { layer.addTo(map); matched.push(inner.feature); }
  });
  updateDashboardCounts(matched);
}

/* saved filters localStorage */
function loadSavedFilters(){
  const s = localStorage.getItem('vf_saved_filters');
  const arr = s ? JSON.parse(s) : [];
  savedFilters.innerHTML = '<option value="">Load saved filter</option>';
  arr.forEach((f,i)=> { const opt = document.createElement('option'); opt.value=i; opt.textContent=f.name; savedFilters.appendChild(opt); });
}
saveFilterBtn.addEventListener('click', ()=> {
  const name = prompt('Save current filter as (name):');
  if (!name) return;
  const obj = { name, q: searchInput.value||'', status: statusFilter.value };
  const s = localStorage.getItem('vf_saved_filters');
  const arr = s ? JSON.parse(s) : [];
  arr.push(obj);
  localStorage.setItem('vf_saved_filters', JSON.stringify(arr));
  loadSavedFilters();
});
savedFilters.addEventListener('change', ()=> {
  const idx = savedFilters.value;
  if (idx === '') return;
  const arr = JSON.parse(localStorage.getItem('vf_saved_filters')||'[]');
  const f = arr[idx]; if (!f) return;
  searchInput.value = f.q; statusFilter.value = f.status; applySearchFilter();
});

searchInput.addEventListener('input', ()=> applySearchFilter());
statusFilter.addEventListener('change', ()=> applySearchFilter());

/* export visible claims to GeoJSON */
exportBtn.addEventListener('click', ()=> {
  const feats = [];
  layerMap.forEach(layer => {
    if (map.hasLayer(layer)) {
      const inner = layer.getLayers ? layer.getLayers()[0] : layer;
      if (inner && inner.feature) feats.push(inner.feature);
    }
  });
  const fc = { type:'FeatureCollection', features:feats };
  const blob = new Blob([JSON.stringify(fc,null,2)], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = `visible_claims_${new Date().toISOString().split('T')[0]}.geojson`; document.body.appendChild(a); a.click(); a.remove(); window.URL.revokeObjectURL(url);
  alert('Exported visible claims.');
});

/* Loading state datasets (paths unchanged) */
(async function loadDatasets(){
  const files = [
    'assets/data/sample-claims.geojson',
    'assets/data/mp-claims.geojson',
    'assets/data/tripura-claims.geojson',
    'assets/data/telangana-claims.geojson'
  ];
  let loadedCount = 0, totalFeatures = 0;
  for (const f of files){
    try {
      const resp = await fetch(f, { cache: 'no-store' });
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const j = await resp.json();
      (j.features || []).forEach(feat => {
        addFeature(feat);
        totalFeatures++;
      });
      loadedCount++;
    } catch (err) {
      console.warn('Could not load', f, err.message);
    }
  }
  if (totalFeatures === 0) {
    updateDashboardCounts([fallbackFeature]);
  } else {
    const allB = [];
    layerMap.forEach(l => {
      const inner = l.getLayers ? l.getLayers()[0] : l;
      if (inner && inner.getBounds) allB.push(inner.getBounds());
    });
    if (allB.length) {
      const union = allB.reduce((acc,b)=>acc.extend(b), allB[0].clone());
      map.fitBounds(union, { padding:[60,60] });
    }
    rebuildClusterAndHeat();
    rebuildAutocomplete();
    const allFeatures = [];
    layerMap.forEach(l => { const inner = l.getLayers ? l.getLayers()[0] : l; if (inner && inner.feature) allFeatures.push(inner.feature); });
    updateDashboardCounts(allFeatures);
  }
  loadSavedFilters();
})();

/* rebuildClusterAndHeat duplicate removed — function above used */

/* update dashboard counts */
function updateDashboardCounts(features){
  const counts = { approved: 0, pending: 0, review: 0, rejected: 0 };
  const states = new Set();
  features.forEach(f => {
    const status = (f.properties && (f.properties.status || '')).toLowerCase();
    const st = (f.properties && f.properties.state) || '—';
    states.add(st);
    if (status.includes('approved')) counts.approved++;
    else if (status.includes('pending')) counts.pending++;
    else if (status.includes('review')) counts.review++;
    else if (status.includes('reject')) counts.rejected++;
  });
  document.getElementById('approved-count').textContent = counts.approved;
  document.getElementById('pending-count').textContent = counts.pending;
  document.getElementById('review-count').textContent = counts.review;
  document.getElementById('rejected-count').textContent = counts.rejected;
  document.getElementById('last-update').textContent = 'Updated ' + new Date().toLocaleTimeString();
  document.getElementById('coverageInfo').textContent = `Coverage: ${states.size} States | ${features.length} Active Claims`;
}

/* Role UI & login demo flow */
function refreshUserUI(){
  if (!currentUser) {
    userPanel.style.display = 'none';
    roleActionsBox.style.display = 'none';
    loginOpen.style.display = 'inline-flex';
    return;
  }
  loginOpen.style.display = 'none';
  userPanel.style.display = 'flex';
  userBadge.innerHTML = `<strong style="font-weight:700">${currentUser.username.split('@')[0]}</strong><div style="font-size:12px;color:var(--muted);margin-left:8px">${currentUser.role === 'official' ? 'Government Official' : 'Citizen'}</div>`;
  roleActionsBox.innerHTML = '';
  if (currentUser.role === 'citizen') {
    const raiseBtn = document.createElement('button'); raiseBtn.className = 'btn'; raiseBtn.textContent = 'Raise Claim'; raiseBtn.onclick = citizenRaise;
    const trackBtn = document.createElement('button'); trackBtn.className='btn secondary'; trackBtn.textContent='Track Claim'; trackBtn.onclick = citizenTrack;
    const reportsBtn = document.createElement('button'); reportsBtn.className='btn secondary'; reportsBtn.textContent='My Reports'; reportsBtn.onclick = () => alert('My reports (demo)');
    roleActionsBox.appendChild(raiseBtn); roleActionsBox.appendChild(trackBtn); roleActionsBox.appendChild(reportsBtn);
    roleActionsBox.style.display = 'flex';
  } else {
    const reviewBtn = document.createElement('button'); reviewBtn.className='btn'; reviewBtn.textContent='Review Queue'; reviewBtn.onclick = () => alert('Review queue (demo)');
    const assignBtn = document.createElement('button'); assignBtn.className='btn secondary'; assignBtn.textContent='Assign Verification'; assignBtn.onclick = () => alert('Assign verification (demo)');
    const auditBtn = document.createElement('button'); auditBtn.className='btn secondary'; auditBtn.textContent='Export Audit Log'; auditBtn.onclick = () => alert('Export audit log (demo)');
    roleActionsBox.appendChild(reviewBtn); roleActionsBox.appendChild(assignBtn); roleActionsBox.appendChild(auditBtn);
    roleActionsBox.style.display = 'flex';
  }
}

/* demo citizen functions */
function citizenRaise(){
  const title = prompt('Brief title for claim'); if (!title) return;
  const village = prompt('Village'); if (!village) return;
  const newId = 'CLAIM-' + Date.now().toString().slice(-6);
  const lat = 20.2961 + (Math.random()-0.5)*0.02;
  const lng = 85.8245 + (Math.random()-0.5)*0.02;
  const poly = turfPointToPolygon(lat, lng, 0.004);
  const feat = { type:'Feature', properties:{ claim_id:newId, name:title, village, district:'Unknown', state:'Unknown', status:'Pending', claimant_families:1, area_hectares:0 }, geometry:{ type:'Polygon', coordinates: [poly] } };
  addFeature(feat);
  rebuildClusterAndHeat(); rebuildAutocomplete();
  alert('Claim raised (demo). ID: ' + newId);
}
function citizenTrack(){
  const q = prompt('Enter Claim ID to track'); if (!q) return;
  let found=false;
  layerMap.forEach((layer,id)=> {
    if (id === q) {
      found=true;
      const inner = layer.getLayers ? layer.getLayers()[0] : layer;
      if (inner && inner.getBounds) { map.fitBounds(inner.getBounds(), { padding:[30,30] }); setTimeout(()=> inner.openPopup && inner.openPopup(), 350); }
    }
  });
  if (!found) alert('Claim not found in current dataset.');
}

/* small polygon helper */
function turfPointToPolygon(lat, lng, r) {
  const radius = r || 0.002;
  return [
    [lng - radius, lat - radius],
    [lng + radius, lat - radius],
    [lng + radius, lat + radius],
    [lng - radius, lat + radius],
    [lng - radius, lat - radius]
  ];
}

/* login handlers (demo only) */
loginForm.addEventListener('submit', (e)=> {
  e.preventDefault();
  const role = roleSelect.value;
  const email = document.getElementById('username').value.trim() || (role + '.demo@example.com');
  currentUser = { username: email, role };
  hideModal(loginModal);
  refreshUserUI();
});
loginDemo.addEventListener('click', ()=> {
  const role = roleSelect.value;
  currentUser = { username: role + '.demo@example.com', role };
  hideModal(loginModal); refreshUserUI();
});

/* logout */
logoutBtn.addEventListener('click', ()=> {
  currentUser = null;
  refreshUserUI();
});

/* when popups open, add role-specific action buttons (already set by popupopen listener) */
/* initial UI state */
refreshUserUI();

console.log("VisionForge: full update applied — login, contrast, NDVI timeline, compare, play/pause toggle, clusters, heatmap, export, filters. Firebase placeholder left as null.");
</script>

  <!-- Officer Dashboard: charts, KPI cards, table — insert before </body> -->
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
  /* Officer modal specific styles (keeps theme variables) */
  #officerModal .modal-card { max-width:1100px; width:95%; }
  #officerModal .kpi-row { display:flex; gap:12px; margin-bottom:12px; }
  #officerModal .kpi { flex:1; padding:12px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.02); text-align:center }
  #officerModal .kpi h4 { margin:0 0 6px 0; color:var(--accent-1) }
  #officerModal .charts { display:flex; gap:16px; margin-bottom:12px; }
  #officerModal .charts .chart { flex:1; min-height:240px; background:transparent; padding:8px; border-radius:8px; }
  #officerModal .table-wrap { max-height:340px; overflow:auto; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:var(--input-bg-dark); padding:8px; }
  #officerModal table { width:100%; border-collapse:collapse; font-size:13px; }
  #officerModal th, #officerModal td { padding:8px 6px; border-bottom:1px solid rgba(0,0,0,0.06); text-align:left; color:var(--input-text-dark) }
  #officerModal .toolbar { display:flex; gap:8px; margin-bottom:8px; align-items:center }
  #officerModal .small-muted { font-size:13px; color:var(--muted) }
</style>

<div id="officerModal" class="modal" aria-hidden="true">
  <div class="modal-card" style="padding:14px;">
    <div class="modal-header">
      <h3 style="margin:0">Officer Dashboard — Review Queue</h3>
      <button class="close" id="closeOfficer">&times;</button>
    </div>
    <div class="modal-body" style="padding:12px;">
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px">
        <div style="flex:1">
          <div class="kpi-row">
            <div class="kpi"><h4>Total Claims</h4><div id="kpiTotal" style="font-size:20px;font-weight:800">0</div></div>
            <div class="kpi"><h4>Deforestation Alerts</h4><div id="kpiAlerts" style="font-size:20px;font-weight:800;color:#e04c4c">0</div></div>
            <div class="kpi"><h4>Total Families</h4><div id="kpiFamilies" style="font-size:20px;font-weight:800">0</div></div>
            <div class="kpi"><h4>Total Area (ha)</h4><div id="kpiArea" style="font-size:20px;font-weight:800">0</div></div>
          </div>
        </div>
        <div style="width:220px;display:flex;flex-direction:column;gap:8px">
          <button id="exportCSV" class="btn" style="background:linear-gradient(135deg,#10b981,#06b6d4);color:var(--btn-text-light)">Export CSV</button>
          <button id="focusAlerts" class="btn secondary">Focus Alerts</button>
        </div>
      </div>

      <div class="charts">
        <div class="chart" style="min-width:260px">
          <canvas id="statusPie"></canvas>
        </div>
        <div class="chart">
          <canvas id="stateBar"></canvas>
        </div>
      </div>

      <div class="toolbar">
        <input id="officerSearch" placeholder="Search claim id / village / district / state" class="form-control" style="flex:1" />
        <select id="officerStatusFilter" class="form-control" style="width:160px">
          <option value="all">All statuses</option>
          <option value="approved">Approved</option>
          <option value="pending">Pending</option>
          <option value="review">Under Review</option>
          <option value="rejected">Rejected</option>
        </select>
      </div>

      <div class="table-wrap">
        <table id="claimsTable">
          <thead><tr><th>ID</th><th>State</th><th>District</th><th>Village</th><th>Status</th><th>Area(ha)</th><th>Families</th><th>Alert</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="margin-top:10px;text-align:right"><button id="closeOfficerFooter" class="btn secondary">Close</button></div>
    </div>
  </div>
</div>

<script>
(function(){
  // Ensure Chart.js is loaded
  if (!window.Chart) { console.warn('Chart.js missing'); }

  // modal wiring
  const officerModal = document.getElementById('officerModal');
  const closeOfficer = document.getElementById('closeOfficer');
  const closeOfficerFooter = document.getElementById('closeOfficerFooter');
  closeOfficer.addEventListener('click', ()=> hideOfficer());
  closeOfficerFooter.addEventListener('click', ()=> hideOfficer());

  function showOfficer(){ officerModal.classList.add('open'); officerModal.style.display='flex'; officerModal.setAttribute('aria-hidden','false'); }
  function hideOfficer(){ officerModal.classList.remove('open'); officerModal.style.display='none'; officerModal.setAttribute('aria-hidden','true'); }

  // find Review Queue button dynamically and wire it (roleActionsBox is filled at login)
  function wireReviewButton(){
    const btns = roleActionsBox.querySelectorAll('button');
    btns.forEach(b => {
      if (b.textContent && b.textContent.trim() === 'Review Queue') {
        b.onclick = (e)=> { e.preventDefault(); buildOfficerDashboard(); showOfficer(); };
      }
    });
  }
  // observe roleActionsBox for changes (so when login creates buttons we attach handler)
  const obs = new MutationObserver(wireReviewButton);
  obs.observe(roleActionsBox, { childList:true, subtree:true });
  // Also call once now in case it's already present
  setTimeout(wireReviewButton, 400);

  // Chart placeholders
  let statusChart=null, stateChart=null;

  // build officer dashboard from layerMap features
  function buildOfficerDashboard() {
    // gather features from layerMap
    const features = [];
    layerMap.forEach(layer => {
      const inner = (layer.getLayers ? layer.getLayers()[0] : layer);
      if (!inner) return;
      const feat = inner.feature ? inner.feature : inner;
      if (feat) features.push(feat);
    });

    // compute KPIs
    let totalClaims = features.length;
    let alerts = 0, families = 0, area = 0;
    const statusCounts = {};
    const stateCounts = {};
    features.forEach(f => {
      const p = f.properties || {};
      const s = (p.status || 'Unknown').toString();
      const st = (p.state || 'Unknown').toString();
      statusCounts[s] = (statusCounts[s] || 0) + 1;
      stateCounts[st] = (stateCounts[st] || 0) + 1;
      if (p.deforestation_detected) alerts++;
      families += Number(p.claimant_families||p.claimants||0);
      area += Number(p.area_hectares||0) || 0;
    });

    document.getElementById('kpiTotal').textContent = totalClaims;
    document.getElementById('kpiAlerts').textContent = alerts;
    document.getElementById('kpiFamilies').textContent = families;
    document.getElementById('kpiArea').textContent = Math.round(area);

    // build status pie
    const statusLabels = Object.keys(statusCounts);
    const statusData = statusLabels.map(l => statusCounts[l]);
    const pieCtx = document.getElementById('statusPie').getContext('2d');
    if (statusChart) statusChart.destroy();
    statusChart = new Chart(pieCtx, {
      type:'pie',
      data:{ labels: statusLabels, datasets:[{ data: statusData, backgroundColor:['#27ae60','#f1c40f','#8e44ad','#c0392b','#7f8c8d'] }] },
      options:{ plugins:{ legend:{ position:'bottom' } } }
    });

    // build state bar (top 10)
    const stateEntries = Object.entries(stateCounts).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const stateLabels = stateEntries.map(e=>e[0]);
    const stateData = stateEntries.map(e=>e[1]);
    const barCtx = document.getElementById('stateBar').getContext('2d');
    if (stateChart) stateChart.destroy();
    stateChart = new Chart(barCtx, {
      type:'bar',
      data:{ labels: stateLabels, datasets:[{ label:'Claims', data: stateData }] },
      options:{ indexAxis:'y', plugins:{ legend:{ display:false } }, scales:{ x:{ beginAtZero:true } } }
    });

    // populate table
    const tbody = document.querySelector('#claimsTable tbody');
    tbody.innerHTML = '';
    const rows = features.map(f => {
      const p = f.properties || {};
      return {
        id: p.claim_id || p.name || '—',
        state: p.state||'—',
        district: p.district||'—',
        village: p.village_name||p.village||'—',
        status: p.status||'—',
        area: p.area_hectares || p.area || 0,
        families: p.claimant_families || p.claimants || 0,
        alert: p.deforestation_detected ? 'Yes' : 'No'
      };
    });
    // simple sort: alerts first
    rows.sort((a,b)=> (b.alert==='Yes') - (a.alert==='Yes'));
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><a href="#" class="claim-link" data-id="${r.id}">${r.id}</a></td>
                      <td>${r.state}</td>
                      <td>${r.district}</td>
                      <td>${r.village}</td>
                      <td>${r.status}</td>
                      <td>${r.area}</td>
                      <td>${r.families}</td>
                      <td style="color:${r.alert==='Yes' ? '#c0392b':'#27ae60'}">${r.alert}</td>`;
      tbody.appendChild(tr);
    });

    // wire claim link clicks to zoom
    tbody.querySelectorAll('.claim-link').forEach(a=>{
      a.addEventListener('click', (ev)=>{
        ev.preventDefault();
        const id = a.getAttribute('data-id');
        // find layer and fit bounds
        let found=false;
        layerMap.forEach((layer,key)=>{
          if (key === id) {
            found=true;
            const inner = layer.getLayers ? layer.getLayers()[0] : layer;
            if (inner && inner.getBounds) {
              map.fitBounds(inner.getBounds(), { padding:[40,40] });
              setTimeout(()=> inner.openPopup && inner.openPopup(), 300);
            }
          }
        });
        if (!found) alert('Claim not found in current dataset.');
      });
    });

    // setup filters
    document.getElementById('officerSearch').oninput = filterTable;
    document.getElementById('officerStatusFilter').onchange = filterTable;

    // export CSV
    document.getElementById('exportCSV').onclick = ()=> {
      const csvRows = [['claim_id','state','district','village','status','area_ha','families','alert']];
      rows.forEach(r => csvRows.push([r.id, r.state, r.district, r.village, r.status, r.area, r.families, r.alert]));
      const csv = csvRows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type:'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = `officer_claims_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    };

    // focus alerts button: zoom to those layers
    document.getElementById('focusAlerts').onclick = ()=> {
      const alertBounds = [];
      layerMap.forEach(layer => {
        const inner = layer.getLayers ? layer.getLayers()[0] : layer;
        if (!inner || !inner.feature) return;
        if (inner.feature.properties && inner.feature.properties.deforestation_detected) {
          if (inner.getBounds) alertBounds.push(inner.getBounds());
        }
      });
      if (!alertBounds.length) { alert('No alert layers currently visible'); return; }
      const union = alertBounds.reduce((acc,b)=>acc.extend(b), alertBounds[0].clone());
      map.fitBounds(union, { padding:[50,50] });
    };
  }

  function filterTable(){
    const q = (document.getElementById('officerSearch').value||'').toLowerCase();
    const status = document.getElementById('officerStatusFilter').value;
    const tbody = document.querySelector('#claimsTable tbody');
    Array.from(tbody.children).forEach(tr=>{
      const combined = tr.textContent.toLowerCase();
      const matchesQ = !q || combined.includes(q);
      const matchesStatus = (status === 'all') || combined.includes(status);
      tr.style.display = (matchesQ && matchesStatus) ? '' : 'none';
    });
  }

  // Expose builder so other parts can call it if needed
  window.buildOfficerDashboard = buildOfficerDashboard;

  // if user is already logged in and official, optionally open the dashboard automatically:
  // (safeguard: only open when role=official)
  setTimeout(()=> {
    if (currentUser && currentUser.role === 'official') {
      // build but don't auto-open — keep behind Review Queue button for UX
      buildOfficerDashboard();
    }
  }, 800);

})();
</script>

</body>
</html>
