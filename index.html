<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FRA Atlas DSS â€” Modern UI</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Font & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    :root{
      --glass-bg: rgba(255,255,255,0.06);
      --glass-strong: rgba(255,255,255,0.12);
      --accent1: linear-gradient(135deg,#06b6d4,#3b82f6);
      --accent2: linear-gradient(135deg,#7c3aed,#ef4444);
      --muted: #9aa4b2;
      --card-radius: 14px;
      --shadow-soft: 0 8px 30px rgba(7,10,25,0.18);
      --glass-border: rgba(255,255,255,0.08);
      color-scheme: light;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body,#map{height:100%}
    body{
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:
        radial-gradient(1200px 500px at 10% 10%, rgba(59,130,246,0.08), transparent 15%),
        radial-gradient(1000px 400px at 90% 90%, rgba(124,58,237,0.06), transparent 18%),
        linear-gradient(180deg,#0b1220 0%, #071225 55%, #061222 100%);
      color:#e6eef8;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow:hidden;
    }

    /* Top bar */
    header.appbar{
      position: absolute; left: 24px; right: 24px; top: 18px;
      height:64px; display:flex; align-items:center; gap:16px;
      padding:10px 18px; border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(8px) saturate(120%);
      z-index:1400;
    }
    .brand {
      display:flex; gap:12px; align-items:center;
    }
    .logo {
      width:44px; height:44px; display:grid; place-items:center;
      border-radius:10px; background: linear-gradient(135deg,#10b981,#06b6d4);
      box-shadow: 0 6px 18px rgba(6,182,212,0.14);
      font-weight:800; color:#fff;
    }
    .brand h1{font-size:16px; font-weight:700; color: #ecf8ff; letter-spacing:0.2px}
    .brand p{font-size:12px; color:var(--muted); margin-top:2px}

    .top-actions{ margin-left:auto; display:flex; gap:10px; align-items:center}
    .status-pill{
      padding:8px 12px; border-radius:999px; display:flex; gap:8px; align-items:center;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.03); color:var(--muted); font-size:13px;
    }
    .status-pill i{color:#94a3b8}

    /* map container sits full screen */
    #map { position: absolute; inset:0; z-index:1; }

    /* Floating left action rail */
    .action-rail{
      position: absolute; left: 28px; top: 110px; width:64px;
      display:flex; flex-direction:column; gap:12px; z-index:1300;
    }
    .rail-btn{
      width:64px;height:64px;border-radius:14px; display:grid; place-items:center;
      background: var(--glass-bg); border:1px solid var(--glass-border);
      box-shadow: 0 6px 18px rgba(3,7,18,0.4);
      cursor:pointer; transition: transform .14s ease, box-shadow .14s ease;
    }
    .rail-btn:hover{ transform: translateY(-6px); box-shadow: 0 18px 40px rgba(3,7,18,0.6) }
    .rail-btn .fa{ font-size:20px; color:#fff; opacity:0.95; }

    /* Right dashboard */
    .dashboard {
      position: absolute; right: 24px; top: 110px; width:380px; max-height:76vh;
      padding:16px; border-radius:14px; z-index:1300;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      backdrop-filter: blur(8px);
      border:1px solid var(--glass-border);
      box-shadow: var(--shadow-soft);
      overflow:auto;
    }
    .dash-row{ display:flex; gap:12px; align-items:center; margin-bottom:12px }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.03);
      flex:1;
    }
    .card h3{ font-size:13px; color:#dff0ff; margin-bottom:8px }
    .big-num{ font-size:20px; font-weight:800; color:#fff }

    .section-title{ display:flex; align-items:center; justify-content:space-between; margin: 12px 0; color:#dbeeff }
    .section-title span{ font-weight:700; font-size:14px }

    .stat-grid{ display:grid; grid-template-columns: repeat(2,1fr); gap:10px; margin-bottom:8px }
    .stat {
      padding:10px; border-radius:10px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
      border:1px solid rgba(255,255,255,0.02);
    }
    .stat .label{ font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.6px }
    .stat .value{ font-weight:800; font-size:18px; color:#f8fafc }

    .alert-card{
      background: linear-gradient(135deg,#ff7a7a26,#ffb96a12);
      padding:12px; border-radius:10px; color:#fff; font-weight:700; display:flex; gap:10px; align-items:center;
      border:1px solid rgba(255,255,255,0.03);
    }

    /* Legend bottom-left */
    .legend {
      position:absolute; left:28px; bottom:28px; z-index:1300;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.015));
      border-radius:12px; padding:12px; border:1px solid var(--glass-border);
      backdrop-filter: blur(6px); width:220px;
    }
    .legend h4{ font-size:13px; color:#e9f6ff; margin-bottom:8px }
    .legend-item{ display:flex; gap:10px; align-items:center; margin-bottom:8px }
    .legend-color{ width:14px; height:14px; border-radius:3px; border:1px solid rgba(0,0,0,0.18) }

    /* Modal */
    .modal-backdrop {
      position:fixed; inset:0; display:none; z-index:1500; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(3,6,12,0.6), rgba(3,6,12,0.7));
    }
    .modal {
      width: 96%; max-width:640px; border-radius:14px; overflow:hidden; box-shadow: 0 20px 60px rgba(2,6,23,0.8);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid var(--glass-border);
      padding:18px;
    }
    .modal h2{ color:#e7f3ff; margin-bottom:10px; font-size:18px }
    .form-row { display:flex; gap:10px }
    .form-field{ flex:1; display:flex; flex-direction:column; gap:6px; margin-bottom:10px }
    input, textarea, select{
      padding:10px; border-radius:10px; background: rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.03); color:#e6eef8; font-size:13px;
    }
    textarea{ min-height:110px; resize:vertical }
    .btn {
      padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:700; letter-spacing:0.3px;
    }
    .btn-primary{ background: linear-gradient(90deg,#06b6d4,#3b82f6); color:#022; }
    .btn-danger{ background: linear-gradient(90deg,#f43f5e,#fb923c); color:#fff }

    /* Loading overlay */
    .loading-overlay {
      position: fixed; inset:0; display:none; z-index:2000; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(2,6,23,0.4), rgba(2,6,23,0.6));
    }
    .loader-card {
      padding:20px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid var(--glass-border); display:flex; gap:12px; align-items:center;
    }
    .spinner{
      width:48px; height:48px; border-radius:50%;
      border:5px solid rgba(255,255,255,0.06); border-top-color:#06b6d4; animation:spin 1s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg) } }

    /* small responsive */
    @media (max-width:900px){
      .dashboard{ right:16px; width:320px; top:100px }
      .action-rail{ left:16px }
      header.appbar{ left:12px; right:12px }
    }
    @media (max-width:640px){
      .dashboard{ display:none }
      .action-rail{ top:86px; left:12px }
    }
  </style>
</head>
<body>
  <header class="appbar">
    <div class="brand">
      <div class="logo"><i class="fa-solid fa-seedling"></i></div>
      <div>
        <h1>FRA Atlas DSS</h1>
        <p>Forest Rights & Deforestation Decision Support</p>
      </div>
    </div>

    <div class="top-actions">
      <div class="status-pill"><i class="fa-solid fa-satellite"></i><span style="margin-left:6px">Sentinel-2</span></div>
      <div class="status-pill" id="coverage-pill"><i class="fa-solid fa-map"></i><span style="margin-left:6px">4 states</span></div>
      <div class="status-pill" id="monitor-pill"><i class="fa-solid fa-clock-rotate-left"></i><span style="margin-left:6px">Real-time</span></div>
    </div>
  </header>

  <div id="map"></div>

  <!-- Action Rail -->
  <div class="action-rail" aria-hidden="false">
    <button class="rail-btn" id="btn-before" title="Baseline (Before)"><i class="fa-solid fa-calendar-days"></i></button>
    <button class="rail-btn" id="btn-after" title="Current (After)"><i class="fa-solid fa-calendar-check"></i></button>
    <button class="rail-btn" id="btn-reset" title="Reset View"><i class="fa-solid fa-arrows-rotate"></i></button>
    <button class="rail-btn" id="btn-report" title="Report Issue"><i class="fa-solid fa-triangle-exclamation"></i></button>
    <button class="rail-btn" id="btn-export" title="Generate Report"><i class="fa-solid fa-file-export"></i></button>
  </div>

  <!-- Dashboard -->
  <aside class="dashboard" role="complementary">
    <div class="section-title"><span>FRA Summary</span><small style="color:var(--muted);font-weight:600">Live</small></div>

    <div class="dash-row">
      <div class="card">
        <h3>Claims</h3>
        <div class="stat-grid">
          <div class="stat"><div class="label">Approved</div><div class="value" id="approved-count">1,247</div></div>
          <div class="stat"><div class="label">Pending</div><div class="value" id="pending-count">156</div></div>
          <div class="stat"><div class="label">Review</div><div class="value" id="review-count">43</div></div>
          <div class="stat"><div class="label">Rejected</div><div class="value" id="rejected-count">12</div></div>
        </div>
      </div>

      <div class="card">
        <h3>Impact</h3>
        <div style="margin-top:6px">
          <div style="display:flex;justify-content:space-between;margin-bottom:6px"><small class="label" style="color:var(--muted)">Families</small><strong style="color:#eaf6ff">8,542</strong></div>
          <div style="display:flex;justify-content:space-between"><small class="label" style="color:var(--muted)">Hectares</small><strong style="color:#eaf6ff">24,156</strong></div>
        </div>
      </div>
    </div>

    <div style="margin-top:10px" class="alert-card" id="def-alert">
      <i class="fa-solid fa-bell" style="font-size:18px"></i>
      <div>
        <div style="font-size:13px">Deforestation Alert</div>
        <div style="font-size:12px;color:#fff7e6;font-weight:600">CFR-2024-OD-101 â€” NDVI critical</div>
      </div>
    </div>

    <div style="margin-top:12px" class="card">
      <h3 style="margin-bottom:8px">Satellite Monitoring</h3>
      <div style="font-size:13px;color:var(--muted);line-height:1.45">
        Compare NDVI (Sentinel-2) across baseline & current imagery. Toggle from the left rail to visualize change.
      </div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn btn-primary" id="mini-before">Baseline</button>
        <button class="btn btn-danger" id="mini-after">Current</button>
      </div>
    </div>

    <div style="margin-top:12px" class="card">
      <h3>System Analytics</h3>
      <div style="color:var(--muted);font-size:13px;line-height:1.45">
        <p><strong>Coverage:</strong> <span id="coverage-info">4 States</span></p>
        <p><strong>Last Update:</strong> <span id="last-update">Real-time monitoring active</span></p>
        <p><strong>NDVI Threshold:</strong> 0.30 (alert)</p>
      </div>
    </div>

  </aside>

  <!-- Legend -->
  <div class="legend">
    <h4>Map Legend</h4>
    <div class="legend-item"><div class="legend-color" style="background:#ff7800"></div><div>FRA Claim Boundary</div></div>
    <div class="legend-item"><div class="legend-color" style="background:#4caf50;opacity:0.9"></div><div>Healthy Vegetation (High NDVI)</div></div>
    <div class="legend-item"><div class="legend-color" style="background:#ff6b6b;opacity:0.9"></div><div>Forest Loss (Low NDVI)</div></div>
  </div>

  <!-- Modal: Report Issue -->
  <div class="modal-backdrop" id="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <h2 id="modal-title"><i class="fa-solid fa-triangle-exclamation" style="margin-right:8px;"></i>Report Environmental Issue</h2>

      <form id="reportForm">
        <div class="form-row">
          <div class="form-field">
            <label class="label">Issue Type *</label>
            <select id="issueType" required>
              <option value="">Select issue</option>
              <option value="deforestation">Illegal Deforestation</option>
              <option value="encroachment">Encroachment</option>
              <option value="mining">Unauthorized Mining</option>
              <option value="dumping">Waste Dumping</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-field">
            <label class="label">Reporter Name *</label>
            <input id="reporterName" required />
          </div>
        </div>

        <div class="form-row">
          <div class="form-field">
            <label class="label">Location / Village *</label>
            <input id="location" required />
          </div>
          <div class="form-field">
            <label class="label">District *</label>
            <input id="district" required />
          </div>
        </div>

        <div class="form-field">
          <label class="label">Description *</label>
          <textarea id="description" required placeholder="Describe issue, approximate area, when noticed..."></textarea>
        </div>

        <div class="form-row">
          <div class="form-field">
            <label class="label">GPS Coordinates</label>
            <input id="coordinates" placeholder="20.2961, 85.8245"/>
          </div>
          <div style="display:flex;align-items:flex-end; gap:8px">
            <button type="submit" class="btn btn-primary">Submit</button>
            <button type="button" class="btn" id="modal-close" style="background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted)">Cancel</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Loading overlay -->
  <div class="loading-overlay" id="loading-overlay">
    <div class="loader-card">
      <div class="spinner"></div>
      <div>
        <div style="font-weight:800">Analyzing satellite dataâ€¦</div>
        <div style="color:var(--muted);font-size:13px;margin-top:6px" id="loading-sub">Connecting to Sentinel-2</div>
      </div>
    </div>
  </div>

  <!-- Leaflet script -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // --- Map init ---
    const map = L.map('map', { center: [20.2961,85.8245], zoom: 6, zoomControl:false });
    L.control.zoom({position:'topright'}).addTo(map);

    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:''}).addTo(map);
    const positron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{maxZoom:19});

    L.control.scale({position:'bottomright'}).addTo(map);
    const baseMaps = { "OpenStreetMap": osm, "Positron (Light)": positron };
    const overlayMaps = {};
    L.control.layers(baseMaps, overlayMaps, { position: 'topright', collapsed: true }).addTo(map);

    // sample built-in claim polygon (keeps parity with your original)
    const claimBoundary = {
      "type":"Feature","properties": {
        "name":"CFR-2024-OD-101","village":"Khandagiri","district":"Khurda",
        "area":"245 hectares","status":"Approved","claimants":"127 families","approval_date":"2024-03-15"
      },
      "geometry":{ "type":"Polygon", "coordinates":[[
        [85.8100,20.3100],[85.8300,20.3100],[85.8300,20.2900],[85.8100,20.2900],[85.8100,20.3100]
      ]]}
    };

    function popupForFeature(feature){
      const p=feature.properties || {};
      return `
        <div style="font-family:Inter,system-ui;">
          <h4 style="margin:0 0 8px;color:#e6fbff">${p.name||'Claim'}</h4>
          <div style="font-size:13px;color:#d1e9ff">
            <div><strong>Village:</strong> ${p.village||'â€”'}</div>
            <div><strong>District:</strong> ${p.district||'â€”'}</div>
            <div><strong>Area:</strong> ${p.area||'â€”'}</div>
            <div><strong>Status:</strong> <span style="font-weight:700;color:${getStatusColor((p.status||'').toLowerCase())}">${p.status||'â€”'}</span></div>
            <div style="margin-top:8px">${p.deforestation_detected ? '<div style="color:#ffebe9;font-weight:800">ðŸš¨ DEFORESTATION ALERT</div>' : '<div style="color:#ddffec;font-weight:700">âœ… No Active Alerts</div>'}</div>
          </div>
        </div>
      `;
    }

    const claimLayer = L.geoJSON(claimBoundary, {
      style:{color:'#ff7800', weight:3, fillColor:'#ff7800', fillOpacity:0.18},
      onEachFeature:function(f,l){ l.bindPopup(popupForFeature(f), {className:'popup-modern'}) }
    });

    const claimsGroup = L.layerGroup([claimLayer]).addTo(map);

    // NDVI overlays via canvas images (like original)
    function makeNDVICanvas(type){
      const c=document.createElement('canvas'); c.width=360; c.height=360;
      const ctx=c.getContext('2d');
      if(type==='before'){
        const g=ctx.createLinearGradient(0,0,360,360);
        g.addColorStop(0,'rgba(72,187,120,0.78)');
        g.addColorStop(1,'rgba(34,197,94,0.78)');
        ctx.fillStyle=g; ctx.fillRect(0,0,360,360);
      } else {
        // base green
        ctx.fillStyle='rgba(34,197,94,0.6)'; ctx.fillRect(0,0,360,360);
        // red patches
        ctx.fillStyle='rgba(244,67,54,0.86)';
        ctx.fillRect(90,120,180,60);
        ctx.fillRect(220,220,80,40);
        ctx.fillRect(50,240,90,30);
      }
      return c.toDataURL();
    }

    const imageBounds = [[20.2900,85.8100],[20.3100,85.8300]];
    const beforeImage = L.imageOverlay(makeNDVICanvas('before'), imageBounds, {opacity:0.6});
    const afterImage = L.imageOverlay(makeNDVICanvas('after'), imageBounds, {opacity:0.6});

    // UI elements
    const btnBefore = document.getElementById('btn-before');
    const btnAfter = document.getElementById('btn-after');
    const btnReset = document.getElementById('btn-reset');
    const btnExport = document.getElementById('btn-export');
    const btnReport = document.getElementById('btn-report');
    const miniBefore = document.getElementById('mini-before');
    const miniAfter = document.getElementById('mini-after');

    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingSub = document.getElementById('loading-sub');
    const lastUpdateEl = document.getElementById('last-update');
    const coverageInfo = document.getElementById('coverage-info');
    const coveragePill = document.getElementById('coverage-pill');

    function showLoading(text){ loadingSub.textContent = text||'Processingâ€¦'; loadingOverlay.style.display='flex'; }
    function hideLoading(){ loadingOverlay.style.display='none'; }

    btnBefore.addEventListener('click', ()=>{ toggleBefore() });
    miniBefore.addEventListener('click', ()=>{ toggleBefore() });
    btnAfter.addEventListener('click', ()=>{ toggleAfter() });
    miniAfter.addEventListener('click', ()=>{ toggleAfter() });
    btnReset.addEventListener('click', ()=>{ map.removeLayer(beforeImage); map.removeLayer(afterImage); map.setView([20.2961,85.8245],12); });
    btnReport.addEventListener('click', ()=>{ openModal() });
    btnExport.addEventListener('click', ()=>{ generateReport() });

    function toggleBefore(){
      showLoading('Loading baseline imageryâ€¦');
      setTimeout(()=>{
        map.removeLayer(afterImage); beforeImage.addTo(map);
        hideLoading();
        const p = L.popup({autoClose:true}).setLatLng([20.3000,85.8200]).setContent('<div style="text-align:center;"><strong>January 2025</strong><br>Healthy forest â€” NDVI: 0.75</div>').openOn(map);
        setTimeout(()=>map.closePopup(p),3000);
      },1200);
    }
    function toggleAfter(){
      showLoading('Analyzing current sceneâ€¦');
      setTimeout(()=>{
        map.removeLayer(beforeImage); afterImage.addTo(map);
        hideLoading();
        const p = L.popup({autoClose:true}).setLatLng([20.2980,85.8150]).setContent('<div style="text-align:center;color:#ffdddd"><strong>September 2025</strong><br>Deforestation detected â€” NDVI: 0.21</div>').openOn(map);
        setTimeout(()=>map.closePopup(p),4000);
      },1400);
    }

    // Export report (text file like original for simplicity)
    function generateReport(){
      showLoading('Preparing reportâ€¦');
      setTimeout(()=>{
        const r = gatherReportData();
        const content = `
FRA ATLAS DSS â€” REPORT
Generated: ${new Date().toLocaleString()}

EXECUTIVE SUMMARY
Total FRA Claims Monitored: ${r.totalClaims}
Coverage: ${r.coverage}

CLAIM STATUS
Approved: ${r.approved}
Pending: ${r.pending}
Under Review: ${r.review}
Rejected: ${r.rejected}

ENVIRONMENTAL ALERTS
Deforestation Alerts (estimated): ${r.deforestationAlerts}
High-risk Areas: ${r.highRiskAreas}

COMMUNITY IMPACT
Families Protected: 8,542
Hectares Secured: 24,156

TECHNICAL
Satellite: Sentinel-2 (10m)
NDVI Threshold: 0.30
Update Frequency: Bi-weekly

RECOMMENDATIONS
1. Investigate pending claims: ${r.pending}
2. Ground verification for ${r.deforestationAlerts} alerts

-- FRA Atlas DSS
        `;
        const blob = new Blob([content], {type:'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download=`FRA_Atlas_Report_${new Date().toISOString().slice(0,10)}.txt`;
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        hideLoading();
        alert('ðŸ“„ Report generated and downloaded.');
      },1200);
    }

    function gatherReportData(){
      const counts = Array.from(document.querySelectorAll('.value')).map(n=>parseInt(n.textContent.replace(/[^0-9]/g,''))||0);
      const total = counts.reduce((s,n)=>s+n,0);
      return {
        totalClaims: total,
        approved: counts[0]||0,
        pending: counts[1]||0,
        review: counts[2]||0,
        rejected: counts[3]||0,
        deforestationAlerts: Math.floor(Math.random()*6)+2,
        highRiskAreas: Math.floor(Math.random()*4)+1,
        coverage: 'Odisha, MP, Tripura, Telangana'
      };
    }

    // Report modal logic
    const modalBackdrop = document.getElementById('modal-backdrop');
    const modalClose = document.getElementById('modal-close');
    const reportForm = document.getElementById('reportForm');

    function openModal(){ modalBackdrop.style.display='flex'; modalBackdrop.setAttribute('aria-hidden','false'); }
    function closeModal(){ modalBackdrop.style.display='none'; modalBackdrop.setAttribute('aria-hidden','true'); }

    modalClose.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) closeModal(); });

    reportForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      showLoading('Submitting reportâ€¦');
      setTimeout(()=>{
        hideLoading();
        closeModal();
        reportForm.reset();
        alert('âœ… Report submitted successfully!\nReport ID: ENV-' + Date.now().toString().slice(-6));
      },1500);
    });

    // load external state datasets (same approach)
    (async function loadAllStateDatasets(){
      showLoading('Loading claim datasets - run on http(s) for full demo');
      const stateFiles = [
        'assets/data/sample-claims.geojson',
        'assets/data/mp-claims.geojson',
        'assets/data/tripura-claims.geojson',
        'assets/data/telangana-claims.geojson'
      ];
      const loadedFeatures = [];
      let successCount=0;
      for(const f of stateFiles){
        try{
          const resp = await fetch(f,{cache:'no-store'});
          if(!resp.ok) throw new Error(resp.status);
          const data = await resp.json();
          loadedFeatures.push(...(data.features||[]));
          successCount++;
          console.log('Loaded', f, (data.features||[]).length);
        }catch(err){
          console.warn('Failed to load',f,err);
        }
      }

      if(loadedFeatures.length>0){
        claimsGroup.clearLayers();
        const fc = { type:'FeatureCollection', features: loadedFeatures };
        const loaded = L.geoJSON(fc, {
          style: feat => {
            const s=(feat.properties.status||'').toLowerCase();
            const hasAlert = feat.properties.deforestation_detected;
            let color='#ff7800';
            if(s.includes('approved')) color='#27ae60';
            else if(s.includes('pending')) color='#f1c40f';
            else if(s.includes('review')) color='#8e44ad';
            else if(s.includes('reject')) color='#c0392b';
            return { color: hasAlert ? '#e74c3c' : color, weight: hasAlert?3.5:2.5, fillColor: color, fillOpacity: hasAlert?0.42:0.18, dashArray: hasAlert?'5,5':null };
          },
          onEachFeature: function(f,l){
            l.bindPopup(popupForFeature(f),{maxWidth:320,className:'popup-modern'});
          }
        });
        claimsGroup.addLayer(loaded);
        try { map.fitBounds(loaded.getBounds(), {padding:[40,40]}); } catch(e){ map.setView([20.5937,78.9629],6); }
        updateDashboardCounts(loadedFeatures);
        coverageInfo.textContent = `${successCount} States | ${loadedFeatures.length} Active Claims`;
        coveragePill.querySelector('span')?.setAttribute?('':'');
      } else {
        // fallback - keep built-in sample
        claimsGroup.clearLayers();
        claimsGroup.addLayer(claimLayer).addTo(map);
        try { map.fitBounds(claimLayer.getBounds(), {padding:[30,30]}); } catch(e){}
      }
      hideLoading();
    })();

    function updateDashboardCounts(features){
      const counts = {approved:0,pending:0,review:0,rejected:0};
      features.forEach(f=>{
        const s=(f.properties.status||'').toLowerCase();
        if(s.includes('approved')) counts.approved++;
        else if(s.includes('pending')) counts.pending++;
        else if(s.includes('review')) counts.review++;
        else if(s.includes('reject')) counts.rejected++;
      });
      document.getElementById('approved-count').textContent = counts.approved;
      document.getElementById('pending-count').textContent = counts.pending;
      document.getElementById('review-count').textContent = counts.review;
      document.getElementById('rejected-count').textContent = counts.rejected;
      lastUpdateEl.textContent = 'Updated ' + new Date().toLocaleTimeString();
    }

    function getStatusColor(s){
      s = (s||'').toLowerCase();
      if(s.includes('approved')) return '#27ae60';
      if(s.includes('pending')) return '#f39c12';
      if(s.includes('review')) return '#8e44ad';
      if(s.includes('reject')) return '#c0392b';
      return '#94a3b8';
    }

    // initial guidance popup
    setTimeout(()=> {
      try {
        const first = claimsGroup.getLayers()[0];
        const inner = first && first.getLayers ? (first.getLayers()[0]||first) : first;
        if(inner && inner.openPopup) inner.openPopup();
      } catch(e){}
    }, 2400);

    console.log("Modern FRA Atlas UI loaded â€” ready for presentation.");
  </script>
</body>
</html>
